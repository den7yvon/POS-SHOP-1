<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POS | Stock</title>
  <link rel="shortcut icon" type="image/x-icon" href="Favicon.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {display: flex; font-family: 'Times New Roman', Times, serif; line-height: 1.4; min-height: 100vh;
      flex-direction: column; margin: 0; background-color: #f1f4f8;}

    .title {color: #003366; font-size: 24px; margin-bottom: 20px;}

    .main {background-color: white; border-radius: 15px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      padding: 25px; width: 90%; max-width: 400px; text-align: center;}

    .top-nav {width: 100%; height: 40px; background-color: #003366; color: white; display: flex;
      justify-content: space-between; align-items: center; padding: 0 15px; position: fixed;
      top: 0; z-index: 100;}
  
    .nav-left, .nav-center, .nav-right {display: flex; align-items: center; position: relative;}
  
    .menu-icon {font-size: 24px; cursor: pointer; margin-right: 10px;}
  
    .active-page {font-size: 16px; font-weight: 600;}
  
    .menu-dropdown {position: absolute; top: 40px; left: 0; background: white; color: #003366;
      border: 1px solid #ccc; border-radius: 6px; display: none; flex-direction: column; width: 220px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);  overflow: hidden; z-index: 1000;}
    
    .menu-dropdown a {padding: 10px; text-decoration: none; color: #003366; 
      border-bottom: 1px solid #eee; font-weight: 500;}
    
    .menu-dropdown a:hover {background-color: #f0f0f0;}
    
    .menu-dropdown.show {display: flex;}
    
    .nav-logo {font-size: 22px; font-weight: bold; margin-right: 70px;}

    .user-icon {cursor: pointer; margin-right: 30px;}
    
    .circle {width: 36px; height: 36px; background-color: white; border-radius: 50%; position: relative;
      display: flex; align-items: center; justify-content: center;}
    
    .head {width: 10px; height: 10px; background-color: #003366; border-radius: 50%;
      position: absolute; top: 8px;}
    
    .shoulders {width: 20px; height: 8px; background-color: #003366; border-radius: 50%; position: absolute;
      bottom: 8px;}

    .user-dropdown {position: absolute; top: 40px; right: 0; background: white;
      color: #003366; padding: 10px; border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      display: none; z-index: 1000; width: 160px; text-align: center;}
    
    .user-dropdown.show {display: block;}
    
    .user-dropdown p {margin: 0 0 10px;}
    
    .user-dropdown button {background-color: #003366; color: white; border: none; padding: 8px 12px;
      border-radius: 4px; cursor: pointer; width: 90%;}
    
    .user-dropdown button:hover {background-color: #0055aa;}

    .main-content {margin-top: 30px; padding: 20px;}

    .foot {width: 100%; background-color: #003366; color: white; text-align: center; padding: 2px 1px;
      position: fixed; bottom: 0; left: 0; font-size: 10px;}

    #pageLoader {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9);
        z-index: 9999; display: flex; align-items: center; justify-content: center;}
  
    .spinner {border: 6px solid #ccc; border-top: 6px solid #2f0fe4; border-radius: 50%; width: 40px; height: 40px;
        animation: spin 1s linear infinite;}
  
    @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}

    .stock-wrapper {text-align: center;}

    .stock-heading {font-size: 24px; font-weight: 600; margin-bottom: 20px; color: #333;}

    .stock-button-group {display: flex; flex-direction: column; gap: 15px; align-items: center;
      transition: all 0.3s ease;}

    .stock-btn {background-color: #003366; color: white; border: none; font-weight: bold;
      padding: 12px 12px; border-radius: 8px; font-size: 16px; cursor: pointer; min-width: 180px;
      transition: background-color 0.3s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);}

    .stock-btn:hover {background-color: #0055aa;}

    .hidden {display: none;}

    .animate-fade-in {animation: fadeInUp 1.0s ease;}

    @keyframes fadeInUp {from {opacity: 0; transform: translateY(100px);} to {opacity: 1; transform: translateY(0);}}

    .white-arrow {color: white;}

    .back-btn {background-color: #087ef5 ; color: white; padding: 12px 20px; margin-top: 15px;
      font-size: 1rem; font-weight: 500; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;}

    .back-btn:hover {background-color: blue;}

    .back-btn-edit {background-color: #087ef5 ; color: white; padding: 4px 4px; margin-top: 0; font-size: 1rem;
      font-weight: 500; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 7px;}

    .back-btn-edit:hover {background-color: blue;}

    .overlay {position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 9990;}

    .hidden {display: none;}

    .popup-content {background: white; padding: 30px; border-radius: 12px; width: 350px;
      box-shadow: 0 0 10px rgba(0,0,0,0.25); animation: fadeInUp 0.5s ease; position: relative;
      max-height: 80vh; overflow-y: auto;}

    .popup-content::-webkit-scrollbar {width: 6px;}

    .popup-content::-webkit-scrollbar-thumb {background: #ccc; border-radius: 3px;}

    .popup-content.small {width: 300px; text-align: center; align-items: center;}

    .popup-header {background:#003366 ; padding: 12px 16px; display: flex; align-items: center;
      justify-content: space-between; border-top-left-radius: 12px; border-top-right-radius: 12px;
      margin: -30px -30px 20px;}

    .popup-header h2 {margin: 0; font-size: 1.4rem; color: white;}

    .popup-header .close-btn {position: static; font-size: 22px; background: transparent; border: none;
      cursor: pointer; color: white;}

    label {display: block; margin-top: 1px; font-weight: 500;}

    input[type="text"], input[type="number"], input[type="file"] {width: 100%; padding: 8px; margin-top: 1px;
      margin-bottom: 1px; border: 1px solid #ccc; border-radius: 6px;}

    .popup-content input[type="password"] {width: 70%; padding: 8px; margin-top: 10px; border: 1px solid #ccc;
      border-radius: 5px;}

    .complete-btn {margin-top: 20px; width: 100%; padding: 10px; background: #003366; color: white;
      font-weight: bold; border: none; border-radius: 6px; cursor: pointer;}

    .complete-btn:hover{background-color: #0055aa;}

    .popup-buttons button {margin: 10px 5px 0; padding: 10px 15px; border: none; border-radius: 6px;
      font-weight: bold; cursor: pointer;}

    .popup-buttons button:first-child {background-color: #003366; color: white; font-weight: bold;}

    .popup-buttons button:first-child:hover {background-color: #0055aa;}

    .popup-buttons button:last-child {background-color: orange; color: white; font-weight: bold;}

    .popup-buttons button:last-child:hover {background-color: #aa7d00;}

    @keyframes fadeInUp {from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0);
      opacity: 1;}}

    .checkmark {width: 80px; height: 80px; stroke: #003366; stroke-width: 4; stroke-linecap: round;
      stroke-linejoin: round; stroke-miterlimit: 10; animation: drawCircle 0.6s ease-in-out forwards;
      display: block; overflow: visible; box-sizing: content-box;}

    .checkmark-circle {stroke-dasharray: 166; stroke-dashoffset: 166;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;}

    .checkmark-check {stroke-dasharray: 48; stroke-dashoffset: 48;
      animation: stroke 0.3s 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;}

    @keyframes stroke {to {stroke-dashoffset: 0;}}

    @keyframes drawCircle {0% {transform: scale(0); opacity: 0;} 100% {transform: scale(1); opacity: 1;}}

    .tick-animation {display: flex; justify-content: center; align-items: center; margin: 20px 0;}

    .popup-header {background: #003366; color: white; display: flex; align-items: center;
      justify-content: space-between; padding: 10px; border-top-left-radius: 12px;
      border-top-right-radius: 12px; margin: -30px -30px 20px -30px;}

    .popup-header h2 {margin: 0; font-size: 1.3rem;}

    .popup-header .close-btn {font-size: 20px; background: transparent; border: none; color: white;
      cursor: pointer;}

    .filter-buttons {display: flex; justify-content: center; gap: 8px; margin-bottom: 10px;}
      
    .filter-buttons button {padding: 8px 16px; font-size: 15px; border: none; background-color: #003366;
      color: white; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;}
        
    .filter-buttons button.active {background-color: #0055aa;}      
        
    .items-container {display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px; justify-content: start;}
        
    .item-card {background-color: white; border-radius: 10px; padding: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); text-align: center; font-size: 14px;}
        
    .item-card img {width: 100%; height: 100px; object-fit: cover; border-radius: 6px; margin-bottom: 6px;}
        
    .item-card h3 {font-size: 15px; margin: 5px 0 3px;}
        
    .item-card p {font-size: 14px; margin: 4px 0; color: #444;}
        
    .item-card button {margin-top: 6px; background-color: #003366; color: white; border: none;
      padding: 6px 10px; border-radius: 4px; font-size: 13px; cursor: pointer; width: 100%;}
        
    .item-card button:hover {background-color: #0055aa;}
        
    .item-card button {margin-top: 6px; background-color: #003366; color: white; border: none;
      padding: 6px 10px; border-radius: 4px; font-size: 13px; cursor: pointer; width: 100%;}
        
    .item-card button:hover {background-color: #0055aa;}

    .search-bar-container {position: fixed; top: 45px; right: 20px; z-index: 99;}
  
    #itemSearch {padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;
      width: 70px;}
  
    #notFound {display: none; text-align: center; color: #003366; margin-top: 30px; font-size: 16px;}
  
    #notFound::before {content: "üïµÔ∏è‚Äç‚ôÇÔ∏è"; font-size: 100px; display: block; margin-bottom: 10px;}
  
    .edit-stock{text-align: center;}

    .image-wrapper {display: flex; justify-content: center; margin-bottom: 10px;}

    .popup-content img {max-width: 100px; border-radius: 6px; margin-bottom: 10px;}
 
    .popup-buttons button.edit-back{background-color: #003366; cursor: pointer; width: 50%;}

    .popup-buttons button.edit-back:hover{background-color: #0055aa;}

    .item-card .delete-btn {background-color: red; color: white; border: none; padding: 6px 10px;
      margin-top: 8px; cursor: pointer; border-radius: 4px;}

    .item-card .delete-btn:hover {background-color: maroon;}
  </style>
</head>
<body class="dashboard-page">
    <!-- Loader Spinner -->
    <div id="pageLoader">
      <div class="spinner"></div>
    </div>

  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="nav-left">
      <div class="menu-icon" onclick="toggleMenuDropdown()">‚ò∞</div>
      <span class="active-page" id="activePageName">Stock</span>
      <div class="menu-dropdown" id="menuDropdown">
        <a href="dashboard.html">‚û§ Dashboard</a>
        <a href="stock.html">‚û§ Stock</a>       
        <a href="expenses.html">‚û§ Expenses</a> 
        <a href="sales.html">‚û§ Sales Records</a>
        <a href="orders.html">‚û§ Orders Management</a>
        <a href="analysis.html">‚û§Analysis</a>
      </div>
    </div>

    <div class="nav-center">
      <span class="nav-logo">POS</span>
    </div>

    <div class="nav-right">
      <div class="user-icon" onclick="toggleUserDropdown()">
        <div class="circle">
          <div class="head"></div>
          <div class="shoulders"></div>
        </div>
      </div>
      <div class="user-dropdown" id="userDropdown">
        <p><strong>Piden Electronics</strong></p>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Content Area Placeholder -->
  <main class="main-content">
    <div id="stockManager" class="stock-wrapper">
      <h2 class="stock-heading">Manage your stock here</h2>
      
      <div id="stockButtons" class="stock-button-group animate-fade-in">
        <button class="stock-btn" onclick="showAddStock()"><span class="white-arrow">‚û§</span> Add Stock</button>
        <button class="stock-btn" onclick="openPasswordPopup()"><span class="white-arrow">‚û§</span> Edit Stock</button>
      </div>
    
      <div id="addStockOptions" class="stock-button-group animate-fade-in hidden">
        <button class="stock-btn" style="margin-top: 30px;" onclick="openAddProductPopup()"><span class="white-arrow">‚û§</span> Add Product</button>
        <button class="stock-btn" onclick="openAddServicePopup()"><span class="white-arrow">‚û§</span> Add Service</button>
        <button class="back-btn-edit" onclick="goBackToStockMain()"><span class="white-arrow"></span>‚Æú Back</button>
      </div>
    </div>
    
    <!-- üì¶ Add Product Popup -->
    <div id="addProductPopup" class="overlay hidden">
      <div class="popup-content">
        <div class="popup-header">
          <h2>Add Product</h2> 
          <button class="close-btn" onclick="closeAddProductPopup()">√ó</button>
        </div>

        <label>Product Image (Not a Must)</label>
        <input type="file" id="productImage" accept="image/*" />

        <label>Product Name</label>
        <input type="text" id="productName" onblur="checkDuplicateProduct()" />

        <label>Quantity</label>
        <input type="number" id="productStock" />

        <label>Buying Price</label>
        <input type="number" id="buyingPrice"  oninput="calculateProfit()"/>

        <label>Selling Price</label>
        <input type="number" id="sellingPrice" oninput="calculateProfit()" />

        <label>Profit</label>
        <input type="text" id="productProfit" readonly />

        <button onclick="submitNewProduct()" class="complete-btn">Complete</button>
      </div>
    </div>

    <!-- ‚úÖ Success Popup -->
    <div id="successPopup" class="overlay hidden">
      <div class="popup-content small">
        <h2>Stock Added Successfully!</h2>
        <div class="tick-animation">
          <svg class="checkmark" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17"/>
          </svg>
        </div>
        <div class="popup-buttons">
          <button onclick="window.location.href='dashboard.html'">üìÑ View</button>
          <button onclick="returnToAddOptions()">‚ûï Add Next Stock</button>
        </div>
      </div>
    </div>

    <!-- üõ†Ô∏è Add Service Popup -->
    <div id="addServicePopup" class="overlay hidden">
      <div class="popup-content">
        <div class="popup-header">
          <h2>Add Service</h2>
          <button class="close-btn" onclick="closeAddServicePopup()">√ó</button>      
        </div>

        <label>Service Image (Not a Must)</label>
        <input type="file" id="serviceImage" accept="image/*" />

        <label>Service Name</label>
        <input type="text" id="serviceName" onblur="checkDuplicateService()" />

        <label>Cost of Service</label>
        <input type="number" id="serviceCost" oninput="calculateServiceProfit()"/>

        <label>Customer Price</label>
        <input type="number" id="servicePrice" oninput="calculateServiceProfit()" />

        <label>Profit</label>
        <input type="text" id="serviceProfit" readonly />

        <button onclick="submitNewService()" class="complete-btn">Complete</button>
      </div>
    </div>

    <div id="editStockSection" class="edit-stock hidden">
    <div id="popupOverlay"></div>
    <h2>Edit Your Stock Here Seamlessly</h2>
    <div class="search-bar-container">
      <input type="text" id="itemSearch" placeholder="üîç Search">
    </div>

    <div class="filter-buttons">
      <button onclick="filterItems('product')" id="productBtn" class="active">Products</button>
      <button onclick="filterItems('service')" id="serviceBtn">Services</button>
    </div>
    <div>  
      <button class="back-btn-edit" onclick="goBackToStockMain()"><span class="white-arrow"></span>‚Æú Back</button>
    </div>

    <div id="itemsContainer" class="items-container">
      <!-- Cards will be loaded here -->
    </div>  

    <div id="notFound">Oops! Item not found</div>
    </div>

    <!-- ‚úèÔ∏è Edit Product Popup -->
    <div id="editProductPopup" class="overlay hidden">
      <div class="popup-content">
        <div class="popup-header">
          <h2>Edit Product</h2>
          <button class="close-btn" onclick="closeEditProductPopup()">√ó</button>
        </div>
        <div class="popup-body">
          <div class="image-wrapper">
          <img id="editProductImagePreview" src="" alt="Product Image">
          </div>
          <label for="editProductImage">Update Image</label>
          <input type="file" id="editProductImage" accept="image/*" />

          <label>Edit Product Name</label>
          <input type="text" id="editProductName" onblur="checkDuplicateProductNameEdit()" />

          <label>Edit Stock</label>
          <input type="number" id="editProductStock" min="0" />

          <label>Edit Buying Price</label>
          <input type="number" id="editBuyingPrice" min="0"  oninput="updateEditProductProfit()"/>

          <label>Edit Selling Price</label>
          <input type="number" id="editSellingPrice" min="0"  oninput="updateEditProductProfit()" />

          <label>Profit</label>
          <input type="text" id="editProductProfit" readonly />

          <button onclick="submitEditProduct()" class="complete-btn">Complete</button>
        </div>
      </div>
    </div>

    <!-- ‚úèÔ∏è Edit Service Popup -->
    <div id="editServicePopup" class="overlay hidden">
      <div class="popup-content">
        <div class="popup-header">
          <h2>Edit Service</h2>
          <button class="close-btn" onclick="closeEditServicePopup()">√ó</button>
        </div>
        <div class="popup-body">
          <div class="image-wrapper">
          <img id="editServiceImagePreview" src="" alt="Service Image">
          </div>
          <label for="editServiceImage">Update Image</label>
          <input type="file" id="editServiceImage" accept="image/*" />

          <label>Edit Service Name</label>
          <input type="text" id="editServiceName" onblur="checkDuplicateServiceNameEdit()" />

          <label>Edit Cost of Service</label>
          <input type="number" id="editCostOfService" min="0" oninput="updateEditServiceProfit()"/>

          <label>Edit Customer Price</label>
          <input type="number" id="editCustomerPrice" min="0" oninput="updateEditServiceProfit()" />

          <label>Profit</label>
          <input type="text" id="editServiceProfit" readonly />

          <button onclick="submitEditService()" class="complete-btn">Complete</button>
        </div>
      </div>
    </div>

    <div id="successEditPopup" class="overlay hidden">
      <div class="popup-content small">
        <h2>Stock Edited Successfully!</h2>
        <div class="tick-animation">
          <svg class="checkmark" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17"/>
          </svg>
        </div>
        <div class="popup-buttons">
          <button class="edit-back" onclick="returnToEditOptions()">Done</button>
        </div>
      </div>
    </div>

    <!-- üî¥ Delete Confirmation Popup -->
    <div id="deletePopup" class="overlay hidden">
      <div class="popup-content small">
        <h2>Are you sure you want to delete this <span id="deleteTypeLabel">item</span>?</h2>
        <div class="popup-buttons">
          <button id="confirmDeleteBtn">‚úÖ Confirm</button>
          <button onclick="closeDeletePopup()">‚ùå Cancel</button>
        </div>
      </div>
    </div>

    <div id="successDeletePopup" class="overlay hidden">
      <div class="popup-content small">
        <h2>Stock Deleted Successfully!</h2>
        <div class="tick-animation">
          <svg class="checkmark" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17"/>
          </svg>
        </div>
        <div class="popup-buttons">
          <button class="edit-back" onclick="returnToStock()">Done</button>
        </div>
      </div>
    </div>

    <div id="passwordPopup" class="overlay hidden">
      <div class="popup-content">
        <div class="popup-header">
          <h2>Admin Access</h2>
          <button class="close-btn" onclick="closePasswordPopup()">√ó</button>
        </div>
        <p>This is a highly protected page. Please Enter admin password to proceed to Edit Stock:</p>
        <input type="password" id="adminPasswordInput" placeholder="Enter password" />
        <p id="passwordError" style="color: red; display: none; margin-top: 10px;">Incorrect password</p>
        <div style="margin-top: 10px;">
          <button onclick="verifyAdminPassword()" class="complete-btn">Confirm</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="foot">
    &copy; 2025 Piden Company Limited.
  </footer>

  <!-- Supabase JS Library (must come FIRST before you use supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Supabase Initialization -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const supabaseUrl = "https://mzvlybnvgpemdayoylfk.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16dmx5Ym52Z3BlbWRheW95bGZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MjkyODMsImV4cCI6MjA2MTAwNTI4M30.bRg54tsPook5UrfUM1p3y2WWkZqv_u7vbHpBGBKrQ4E";
    window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
    });
  </script>
  
  <!-- Inline JS for dropdowns & logout -->
  <script>
    function toggleMenuDropdown() {
      document.getElementById("menuDropdown").classList.toggle("show");
      document.getElementById("userDropdown").classList.remove("show");
    }

    function toggleUserDropdown() {
      document.getElementById("userDropdown").classList.toggle("show");
      document.getElementById("menuDropdown").classList.remove("show");
    }

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    window.onload = () => {
      // Disable back button after logout
      if (!sessionStorage.getItem("loggedIn")) {
        window.location.replace("index.html");
      }
    }

    window.onclick = function(event) {
      if (!event.target.matches('.menu-icon') && !event.target.closest('.menu-dropdown')) {
        document.getElementById("menuDropdown").classList.remove("show");
      }
      if (!event.target.closest('.user-icon') && !event.target.closest('.user-dropdown')) {
        document.getElementById("userDropdown").classList.remove("show");
      }
    }

    window.addEventListener("load", () => {
        document.getElementById("pageLoader").style.display = "none";
      });

      // Optional global control for Supabase calls
      function showLoader() {
        document.getElementById("pageLoader").style.display = "flex";
      }

      function hideLoader() {
        document.getElementById("pageLoader").style.display = "none";
      }

      function showAddStock() {
        document.getElementById("stockButtons").classList.add("hidden");
        document.querySelector(".stock-heading").classList.add("hidden");
        const addStock = document.getElementById("addStockOptions");
        addStock.classList.remove("hidden");
        addStock.classList.add("animate-fade-in");
      }

      function handleEditStock() {
        document.getElementById("stockButtons").classList.add("hidden");
        document.querySelector(".stock-heading").classList.add("hidden");
        document.getElementById("editStockSection").classList.remove("hidden");
      }

      function goBackToStockMain() {
        window.location.href = "stock.html";
      }

      let duplicateDetected = false;

      function openAddProductPopup() {
        document.getElementById("addProductPopup").classList.remove("hidden");
      }

      function closeAddProductPopup() {
        document.getElementById("addProductPopup").classList.add("hidden");
        clearProductFields();
      }

      function calculateProfit() {
        const buying = parseFloat(document.getElementById("buyingPrice").value) || 0;
        const selling = parseFloat(document.getElementById("sellingPrice").value) || 0;
        const profit = selling - buying;
        document.getElementById("productProfit").value = profit;
      }

      async function checkDuplicateProduct() {
        const name = document.getElementById("productName").value.trim();

        if (!name) return;

        const { data, error } = await supabase
          .from("items")
          .select("name")
          .eq("type", "product")
          .ilike("name", name); // Case-insensitive check

        if (data.length > 0) {
          duplicateDetected = true;
          alert(`${name} stock is already added. Please use the Edit Stock option instead.`);
          clearProductFields();
        } else {
          duplicateDetected = false;
        }
      }

      function clearProductFields() {
        document.getElementById("productImage").value = "";
        document.getElementById("productName").value = "";
        document.getElementById("productStock").value = "";
        document.getElementById("buyingPrice").value = "";
        document.getElementById("sellingPrice").value = "";
        document.getElementById("productProfit").value = "";
      }

      async function submitNewProduct() {
        if (duplicateDetected) {
          alert("Duplicate item detected. Cannot add again.");
          return;
        }

        const name = document.getElementById("productName").value.trim();
        const stock = parseInt(document.getElementById("productStock").value) || 0;
        const buying = parseFloat(document.getElementById("buyingPrice").value) || 0;
        const selling = parseFloat(document.getElementById("sellingPrice").value) || 0;
        const profit = selling - buying;
        const imageFile = document.getElementById("productImage").files[0];

        if (!name || isNaN(stock) || isNaN(buying) || isNaN(selling)) {
        alert("Please fill out all the fields before submitting.");
        return;
      }


        showLoader();
        let imageUrl = null;

        // ‚è´ Upload image if exists
        if (imageFile) {
          const filename = `${Date.now()}_${imageFile.name}`;
          const { data: uploadData, error: uploadError } = await supabase
            .storage
            .from("product-images")
            .upload(`images/${filename}`, imageFile)

          if (uploadError) {
            alert("Image upload failed");
            hideLoader();
            return;
          }

          const { data: publicURL } = supabase
            .storage
            .from("product-images")
            .getPublicUrl(`images/${filename}`);

          imageUrl = publicURL.publicUrl;
        }

        // ‚úÖ Insert to Supabase
        const { error } = await supabase
          .from("items")
          .insert([{
            type: "product",
            name,
            buying_price: buying,
            selling_price: selling,
            profit,
            stock,
            image_url: imageUrl,
          }]);

        if (error) {
          alert("Failed to add product.");
          return;
        }

        closeAddProductPopup();
        hideLoader();
        clearProductFields();
        showSuccessPopup();
      }

      function showSuccessPopup() {
        document.getElementById("successPopup").classList.remove("hidden");
      }

      function returnToAddOptions() {
        document.getElementById("successPopup").classList.add("hidden");
        clearProductFields();
        // Optional: You can trigger showing the Add Product/Add Service buttons
      }

      function openAddServicePopup() {
        document.getElementById("addServicePopup").classList.remove("hidden");
      }

      let serviceDuplicateDetected = false;

      async function checkDuplicateService() {
        const name = document.getElementById("serviceName").value.trim();
        if (!name) return;

        const { data, error } = await supabase
          .from("items")
          .select("name")
          .eq("type", "service")
          .ilike("name", name);

        if (data && data.length > 0) {
          serviceDuplicateDetected = true;
          alert(`${name} service is already added. Please use the Edit Stock option instead.`);
          clearServiceForm();
        } else {
          serviceDuplicateDetected = false;
        }
      }

      function calculateServiceProfit() {
        const cost = parseFloat(document.getElementById("serviceCost").value) || 0;
        const price = parseFloat(document.getElementById("servicePrice").value) || 0;
        document.getElementById("serviceProfit").value = (price - cost);
      }

      function clearServiceForm() {
        document.getElementById("serviceName").value = "";
        document.getElementById("serviceCost").value = "";
        document.getElementById("servicePrice").value = "";
        document.getElementById("serviceProfit").value = "";
        document.getElementById("serviceImage").value = "";
      }

      function closeAddServicePopup() {
        clearServiceForm();
        document.getElementById("addServicePopup").classList.add("hidden");
      }

      async function submitNewService() {
        if (serviceDuplicateDetected) {
          alert("Duplicate service detected. Cannot add again.");
          return;
        }

        const name = document.getElementById("serviceName").value.trim();
        const cost = parseFloat(document.getElementById("serviceCost").value);
        const price = parseFloat(document.getElementById("servicePrice").value);
        const profit = price - cost;
        const imageFile = document.getElementById("serviceImage").files[0];

        if (!name || isNaN(cost) || isNaN(price)) {
          alert("Please fill out all the required fields before submitting.");
          return;
        }

        showLoader();
        let imageUrl = null;

        if (imageFile) {
          const filename = `${Date.now()}_${imageFile.name}`;
          const { data: uploadData, error: uploadError } = await supabase
            .storage
            .from("product-images")
            .upload(`images/${filename}`, imageFile);

          if (uploadError) {
            alert("Image upload failed");
            hideLoader();
            return;
          }

          const { data: publicURL } = supabase
            .storage
            .from("product-images")
            .getPublicUrl(`images/${filename}`);
          imageUrl = publicURL.publicUrl;
        }

        const { error } = await supabase
          .from("items")
          .insert([{
            type: "service",
            name,
            cost_service: cost,
            customer_price: price,
            profit,
            stock: 0,
            image_url: imageUrl,
          }]);

        if (error) {
          alert("Failed to add service.");
          hideLoader();
          return;
        }

        closeAddServicePopup();
        hideLoader();
        showSuccessPopup();
      }

      const fallbackProductImg = "Product.png";
      const fallbackServiceImg = "Service.png";

      let currentItems = []; // Store current items for search
      let currentType = "product"; // Track whether user is viewing products or services

      // ‚úÖ MAIN FETCH FUNCTION ‚Äî Get items from Supabase
      async function fetchItemsAndDisplay(type = "product") {
        try {
          showLoader();
          currentType = type;

          const { data, error } = await window.supabase
            .from("items")
            .select("*")
            .eq("type", type)
            .order("name", { ascending: true });

          if (error) throw error;

          currentItems = data;
          renderItems(currentItems);
        } catch (err) {
          console.error("Fetch error:", err);
        } finally {
          hideLoader();
        }
      }

      // ‚úÖ RENDER FUNCTION ‚Äî Displays items (or fallback message)
    function renderItems(items) {
      const container = document.getElementById("itemsContainer");
      const notFound = document.getElementById("notFound");
      container.innerHTML = "";
      notFound.style.display = "none";

      if (!items.length) {
        notFound.style.display = "block";
        return;
      }

      items.forEach(item => {
        const card = document.createElement("div");
        card.classList.add("item-card");

        const img = document.createElement("img");
        img.src = item.image_url || (currentType === "product" ? fallbackProductImg : fallbackServiceImg);
        img.onerror = () => {
          img.src = currentType === "product" ? fallbackProductImg : fallbackServiceImg;
        };

        const name = document.createElement("h3");
        name.textContent = item.name;

        card.appendChild(img);
        card.appendChild(name);

        const stock = document.createElement("p");
        const buying = document.createElement("p");
        const selling = document.createElement("p");
        const profit = document.createElement("p");

        if (currentType === "product") {
          stock.textContent  = "Stock: " + item.stock;
          buying.textContent = "Buying Price: Ksh " + item.buying_price;
          selling.textContent = "Selling Price: Ksh " + item.selling_price;
          profit.textContent = "Profit: Ksh " + (item.selling_price - item.buying_price);

          card.appendChild(stock);
          card.appendChild(buying);
          card.appendChild(selling);
          card.appendChild(profit);
        } else {
          const cost = document.createElement("p");
          cost.textContent = "Cost of Service: Ksh " + item.cost_service;
          selling.textContent = "Customer Price: Ksh " + item.customer_price;
          profit.textContent = "Profit: Ksh " + (item.customer_price - item.cost_service);

          card.appendChild(cost);
          card.appendChild(selling);
          card.appendChild(profit);
        }

        const button = document.createElement("button");
        button.textContent = "Edit";
        button.addEventListener("click", () => {
      if (currentType === "product") {
        openEditProductPopup(item);
      } else {
        openEditServicePopup(item);
      }

      // Optional: Clear search and rerender if you want to reset UI state
      document.getElementById("itemSearch").value = "";
    });
        
        card.appendChild(button);

        const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.classList.add("delete-btn");
    deleteBtn.addEventListener("click", () => {
      openDeletePopup(item);
    });

    card.appendChild(deleteBtn);

        container.appendChild(card);
      });
    }

      async function silentBackgroundSync() {
        try {
          const { data, error } = await window.supabase
            .from("items")
            .select("*")
            .eq("type", currentType)
            .order("name", { ascending: true });

          if (error || !Array.isArray(data)) {
            console.warn("Background sync failed:", error);
            return;
          }

          // Check if data changed before updating
          const current = JSON.stringify(currentItems);
          const incoming = JSON.stringify(data);

          if (current !== incoming) {
            currentItems = data;

            // Only re-render if search input is empty
            const searchValue = document.getElementById("itemSearch").value.trim();
            if (!searchValue) {
              renderItems(currentItems);
            } else {
              console.log("User is typing. Skipping render.");
            }
          }
        } catch (err) {
          console.error("Silent sync error:", err);
        }
      }
      setInterval(silentBackgroundSync, 60000); // Every 1 minute

      // ‚úÖ FILTER BUTTONS ‚Äî Products vs Services
      function filterItems(type) {
        document.getElementById("productBtn").classList.remove("active");
        document.getElementById("serviceBtn").classList.remove("active");
        document.getElementById(type + "Btn").classList.add("active");

        // Clear search input and fetch items
        document.getElementById("itemSearch").value = "";
        fetchItemsAndDisplay(type);
      }

      // ‚úÖ SEARCH INPUT ‚Äî Real-time search by item name
      document.getElementById("itemSearch").addEventListener("input", function () {
        const term = this.value.trim().toLowerCase();
        const filtered = currentItems.filter(item =>
          item.name.toLowerCase().includes(term)
        );
        renderItems(filtered);
      });

      // ‚úÖ ON LOAD ‚Äî Default load products
      document.addEventListener("DOMContentLoaded", async function () {
        document.getElementById("itemSearch").value = ""; // clear search on load
        showLoader();
        await fetchItemsAndDisplay("product");

        requestAnimationFrame(() => {
          setTimeout(() => {
            hideLoader();
          }, 100);
        });
      });

      let currentEditProduct = null;
      let isDuplicateNameEdit = false;

      function openEditProductPopup(product) {
        currentEditProduct = product;

        document.getElementById("editProductPopup").classList.remove("hidden");
        document.getElementById("editProductName").value = product.name;
        document.getElementById("editProductStock").value = product.stock;
        document.getElementById("editBuyingPrice").value = product.buying_price;
        document.getElementById("editSellingPrice").value = product.selling_price;
        document.getElementById("editProductProfit").value = product.selling_price - product.buying_price;
        document.getElementById("editProductImagePreview").src = product.image_url || fallbackProductImg;
      }

      function closeEditProductPopup() {
        document.getElementById("editProductPopup").classList.add("hidden");
      }

      function updateEditProductProfit() {
        const buy = parseFloat(document.getElementById("editBuyingPrice").value) || 0;
        const sell = parseFloat(document.getElementById("editSellingPrice").value) || 0;
        document.getElementById("editProductProfit").value = (sell - buy);
      }

      async function checkDuplicateProductNameEdit() {
        const newName = document.getElementById("editProductName").value.trim();
        if (!newName || newName.toLowerCase() === currentEditProduct.name.toLowerCase()) {
          isDuplicateNameEdit = false;
          return;
        }

        const { data, error } = await supabase
          .from("items")
          .select("name")
          .eq("type", "product")
          .ilike("name", newName);

        if (data && data.length > 0) {
          alert("This name is already used for another product.");
          isDuplicateNameEdit = true;
        } else {
          isDuplicateNameEdit = false;
        }
      }

      async function submitEditProduct() {
        if (isDuplicateNameEdit) return;

        const name = document.getElementById("editProductName").value.trim();
        const stock = parseInt(document.getElementById("editProductStock").value);
        const buying = parseFloat(document.getElementById("editBuyingPrice").value);
        const selling = parseFloat(document.getElementById("editSellingPrice").value);
        const profit = selling - buying;
        const imageFile = document.getElementById("editProductImage").files[0];

        if (!name || isNaN(stock) || isNaN(buying) || isNaN(selling)) {
          alert("All fields except image are required.");
          return;
        }

        showLoader();
        let imageUrl = currentEditProduct.image_url;

        if (imageFile) {
          const filename = `${Date.now()}_${imageFile.name}`;
          const { data: uploadData, error: uploadError } = await supabase
            .storage
            .from("product-images")
            .upload(`images/${filename}`, imageFile, { upsert: true });

          if (uploadError) {
            alert("Image upload failed");
            hideLoader();
            return;
          }

          const { data: publicURL } = supabase
            .storage
            .from("product-images")
            .getPublicUrl(`images/${filename}`);

          imageUrl = publicURL.publicUrl;
        }

        const { error } = await supabase
          .from("items")
          .update({
            name,
            stock,
            buying_price: buying,
            selling_price: selling,
            profit,
            image_url: imageUrl
          })
          .eq("id", currentEditProduct.id);

        if (error) {
          alert("Failed to update product.");
          return;
        }
        hideLoader();
        closeEditProductPopup();
        showSuccessEditPopup();
        fetchItemsAndDisplay("product");
      }

      let currentEditService = null;
      let isDuplicateServiceEdit = false;

      function openEditServicePopup(service) {
        currentEditService = service;

        document.getElementById("editServicePopup").classList.remove("hidden");
        document.getElementById("editServiceName").value = service.name;
        document.getElementById("editCostOfService").value = service.cost_service;
        document.getElementById("editCustomerPrice").value = service.customer_price;
        document.getElementById("editServiceProfit").value = (service.customer_price - service.cost_service);
        document.getElementById("editServiceImagePreview").src = service.image_url || fallbackServiceImg;
      }

      function closeEditServicePopup() {
        document.getElementById("editServicePopup").classList.add("hidden");
      }

      function updateEditServiceProfit() {
        const cost = parseFloat(document.getElementById("editCostOfService").value) || 0;
        const price = parseFloat(document.getElementById("editCustomerPrice").value) || 0;
        document.getElementById("editServiceProfit").value = (price - cost);
      }

      async function checkDuplicateServiceNameEdit() {
        const newName = document.getElementById("editServiceName").value.trim();
        if (!newName || newName.toLowerCase() === currentEditService.name.toLowerCase()) {
          isDuplicateServiceEdit = false;
          return;
        }

        const { data } = await supabase
          .from("items")
          .select("name")
          .eq("type", "service")
          .ilike("name", newName);

        if (data && data.length > 0) {
          alert("This name is already used for another service.");
          isDuplicateServiceEdit = true;
        } else {
          isDuplicateServiceEdit = false;
        }
      }

      async function submitEditService() {
        if (isDuplicateServiceEdit) return;

        const name = document.getElementById("editServiceName").value.trim();
        const cost_service = parseFloat(document.getElementById("editCostOfService").value);
        const customer_price = parseFloat(document.getElementById("editCustomerPrice").value);
        const profit = customer_price - cost_service;
        const imageFile = document.getElementById("editServiceImage").files[0];

        if (!name || isNaN(cost_service) || isNaN(customer_price)) {
          alert("All fields except image are required.");
          return;
        }

        showLoader();
        let imageUrl = currentEditService.image_url;

        if (imageFile) {
          const filename = `${Date.now()}_${imageFile.name}`;
          const { error: uploadError } = await supabase
            .storage
            .from("product-images")
            .upload(`images/${filename}`, imageFile, { upsert: true });

          if (uploadError) {
            alert("Image upload failed");
            return;
          }

          const { data: publicURL } = supabase
            .storage
            .from("product-images")
            .getPublicUrl(`images/${filename}`);

          imageUrl = publicURL.publicUrl;
        }

        const { error } = await supabase
          .from("items")
          .update({
            name,
            cost_service,
            customer_price,
            profit,
            image_url: imageUrl
          })
          .eq("id", currentEditService.id);

        if (error) {
          alert("Failed to update service.");
          return;
        }
        hideLoader();
        closeEditServicePopup();       
        showSuccessEditPopup();
        fetchItemsAndDisplay("service");
      }

      function showSuccessEditPopup() {
        document.getElementById("successEditPopup").classList.remove("hidden");
      }

      function returnToEditOptions() {
        document.getElementById("successEditPopup").classList.add("hidden");
      }

      let itemToDelete = null;

      function openDeletePopup(item) {
        itemToDelete = item;
        document.getElementById("deleteTypeLabel").textContent = item.type;
        document.getElementById("deletePopup").classList.remove("hidden");
      }

      function closeDeletePopup() {
        itemToDelete = null;
        document.getElementById("deletePopup").classList.add("hidden");
      }

      document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
        if (!itemToDelete) return;

        showLoader(); // üîÑ Your existing loader function

        try {
          // üî∏ 1. Delete image from Supabase Storage if present
          if (itemToDelete.image_url) {
            const imagePath = itemToDelete.image_url.split("/").pop();
            const { error: imageError } = await supabase.storage
              .from("product-images")
              .remove(["images/" + imagePath]);

            if (imageError) console.warn("Image delete failed:", imageError.message);
          }

          // üî∏ 2. Delete the item from Supabase DB
          const { error } = await supabase
            .from("items")
            .delete()
            .eq("id", itemToDelete.id);

          if (error) throw error;

          closeDeletePopup();
          showSuccessDeletePopup("Item deleted successfully!");
          fetchItemsAndDisplay(currentType); // üîÑ Refresh UI
        } catch (err) {
          alert("‚ùå Delete failed: " + err.message);
        } finally {
          hideLoader(); // üîÑ Your existing loader hide function
        }
      });

      function showSuccessDeletePopup() {
        document.getElementById("successDeletePopup").classList.remove("hidden");
      }

      function returnToStock() {
        document.getElementById("successDeletePopup").classList.add("hidden");
        clearProductFields();
        // Optional: You can trigger showing the Add Product/Add Service buttons
      }

      function openPasswordPopup() {
        document.getElementById("passwordPopup").classList.remove("hidden");
      }

      function closePasswordPopup() {
        document.getElementById("passwordPopup").classList.add("hidden");
        document.getElementById("adminPasswordInput").value = "";
        document.getElementById("passwordError").style.display = "none";
      }

      const ADMIN_PASSWORD = "Den7yvon";
      function verifyAdminPassword() {
        const input = document.getElementById("adminPasswordInput").value;

        if (input === ADMIN_PASSWORD) {
          closePasswordPopup();
          // ‚úÖ Now proceed to Edit Stock logic
          handleEditStock(); // <- Your function to load the page or section
        } else {
          document.getElementById("passwordError").style.display = "block";
        }
      }
  </script>
</body>
</html>