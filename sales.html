<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POS | Sales</title>
  <link rel="shortcut icon" type="image/x-icon" href="Favicon.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
        body {display: flex; font-family: 'Times New Roman', Times, serif; line-height: 1.4; min-height: 100vh;
      flex-direction: column; margin: 0; background-color: #f1f4f8;}

    .title {color: #003366; font-size: 24px; margin-bottom: 20px;}

    .main {background-color: white; border-radius: 15px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      padding: 25px; width: 90%; max-width: 400px; text-align: center;}

    .top-nav {width: 100%; height: 40px; background-color: #003366; color: white; display: flex;
      justify-content: space-between; align-items: center; padding: 0 15px; position: fixed;
      top: 0; z-index: 100;}
  
    .nav-left, .nav-center, .nav-right {display: flex; align-items: center; position: relative;}
  
    .menu-icon {font-size: 24px; cursor: pointer; margin-right: 10px;}
  
    .active-page {font-size: 16px; font-weight: 600;}
  
    .menu-dropdown {position: absolute; top: 40px; left: 0; background: white; color: #003366;
      border: 1px solid #ccc; border-radius: 6px; display: none; flex-direction: column; width: 220px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);  overflow: hidden; z-index: 1000;}
    
    .menu-dropdown a {padding: 10px; text-decoration: none; color: #003366; 
      border-bottom: 1px solid #eee; font-weight: 500;}
    
    .menu-dropdown a:hover {background-color: #f0f0f0;}
    
    .menu-dropdown.show {display: flex;}
    
    .nav-logo {font-size: 22px; font-weight: bold; margin-right: 70px;}

    .user-icon {cursor: pointer; margin-right: 30px;}
    
    .circle {width: 36px; height: 36px; background-color: white; border-radius: 50%; position: relative;
      display: flex; align-items: center; justify-content: center;}
    
    .head {width: 10px; height: 10px; background-color: #003366; border-radius: 50%;
      position: absolute; top: 8px;}
    
    .shoulders {width: 20px; height: 8px; background-color: #003366; border-radius: 50%; position: absolute;
      bottom: 8px;}

    .user-dropdown {position: absolute; top: 40px; right: 0; background: white;
      color: #003366; padding: 10px; border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      display: none; z-index: 1000; width: 160px; text-align: center;}
    
    .user-dropdown.show {display: block;}
    
    .user-dropdown p {margin: 0 0 10px;}
    
    .user-dropdown button {background-color: #003366; color: white; border: none; padding: 8px 12px;
      border-radius: 4px; cursor: pointer; width: 90%;}
    
    .user-dropdown button:hover {background-color: #0055aa;}

    .main-content {margin-top: 30px; padding: 20px;}

    .foot {width: 100%; background-color: #003366; color: white; text-align: center; padding: 2px 1px;
      position: fixed; bottom: 0; left: 0; font-size: 10px;}

    #pageLoader {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9);
        z-index: 9999; display: flex; align-items: center; justify-content: center;}
  
    .spinner {border: 6px solid #ccc; border-top: 6px solid #2f0fe4; border-radius: 50%; width: 40px; height: 40px;
        animation: spin 1s linear infinite;}
  
    @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}

    /* Global Reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

.sales-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}

.sales-header h1 {
  font-size: 24px;
}

#salesSearch {
  padding: 10px;
  width: min-content;
  border-radius: 6px;
  border: 1px solid #ccc;
}

/* Day Box */
.day-box {
  background: white;
  border-radius: 12px;
  margin-bottom: 30px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.07);
  overflow: hidden;
}

/* Day Header */
.day-header {
  background: #003366;
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.day-header h2 {
  font-size: 18px;
}

.download-btn {
  background: white;
  color: #003366;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}

.download-btn:hover {
  background: #e1ecff;
}

/* Sale Card */
.sale-card {
  margin: 20px;
  padding: 15px 20px;
  border: 1px solid #ddd;
  border-radius: 10px;
  background: #fefefe;
  border-left: 6px solid #003366;
}

.sale-header {
  display: flex;
  justify-content: space-between;
  font-weight: bold;
  margin-bottom: 12px;
  color: #555;
}


/* Sale Footer */
.sale-footer {
  margin-top: 15px;
  text-align: right;
}

.receipt-btn {
  padding: 6px 14px;
  border: none;
  background: #003366;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}

.receipt-btn:hover {
  background: #0055aa;
}

/* Daily Totals */
.daily-footer {
  background: #f0f0f0;
  padding: 20px;
  border-top: 1px solid #ccc;
  border-top: 6px solid #003366;
  border-bottom: 6px solid #003366;
}

.daily-footer h3 {
  text-align: center;
  margin-bottom: 15px;
}

.daily-totals {
  display: flex;
  justify-content: space-around;
  text-align: center;
  font-size: 14px;
}

.daily-totals .category {
  flex: 1;
}

.daily-totals .category h4 {
  margin-bottom: 8px;
  color: #007bff;
}

.sale-table-wrapper {
  overflow-x: auto;
  margin-top: 10px;
}

.sale-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  background: #fff;
}

.sale-table th,
.sale-table td {
  padding: 10px;
  border: 1px solid #ccc;
  text-align: left;
  min-width: 100px;
}

.sale-table thead {
  background-color: #f4f4f4;
  font-weight: bold;
}

.sale-table tbody tr:nth-child(even) {
  background-color: #f9f9f9;
}

.summary-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  text-align: center;
  font-size: 14px;
  background-color: #fff;
}

.summary-table th,
.summary-table td {
  border: 1px solid #ccc;
  padding: 8px;
}

.summary-table th {
  background-color: #f4f4f4;
  font-weight: bold;
}

.summary-wrapper {
  overflow-x: auto;
  width: 100%;
}
  </style>
</head>
<body class="dashboard-page">
    <!-- Loader Spinner -->
    <div id="pageLoader">
      <div class="spinner"></div>
    </div>

  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="nav-left">
      <div class="menu-icon" onclick="toggleMenuDropdown()">☰</div>
      <span class="active-page" id="activePageName">Sales</span>
      <div class="menu-dropdown" id="menuDropdown">
        <a href="dashboard.html">➤ Dashboard</a>
        <a href="stock.html">➤ Stock</a>       
        <a href="expenses.html">➤ Expenses</a> 
        <a href="sales.html">➤ Sales Records</a>
        <a href="orders.html">➤ Orders Management</a>
        <a href="analysis.html">➤Analysis</a>
      </div>
    </div>

    <div class="nav-center">
      <span class="nav-logo">POS</span>
    </div>

    <div class="nav-right">
      <div class="user-icon" onclick="toggleUserDropdown()">
        <div class="circle">
          <div class="head"></div>
          <div class="shoulders"></div>
        </div>
      </div>
      <div class="user-dropdown" id="userDropdown">
        <p><strong>Piden Electronics</strong></p>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Content Area Placeholder -->
  <main class="main-content">
    <div class="sales-header">
      <h3>Records</h3>
      <input type="text" id="salesSearch" placeholder="🔍e.g. Day/Date" />
    </div>
  
    <div id="salesContainer">
      <!-- Day containers with sales will be rendered here -->
    </div>
  </main>

  <!-- Footer -->
  <footer class="foot">
    &copy; 2025 Piden Company Limited.
  </footer>

  <!-- Supabase JS Library (must come FIRST before you use supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Supabase Initialization -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const supabaseUrl = "https://mzvlybnvgpemdayoylfk.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16dmx5Ym52Z3BlbWRheW95bGZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MjkyODMsImV4cCI6MjA2MTAwNTI4M30.bRg54tsPook5UrfUM1p3y2WWkZqv_u7vbHpBGBKrQ4E";
    window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
    });
  </script>
  
  <!-- Inline JS for dropdowns & logout -->
  <script>
    function toggleMenuDropdown() {
      document.getElementById("menuDropdown").classList.toggle("show");
      document.getElementById("userDropdown").classList.remove("show");
    }

    function toggleUserDropdown() {
      document.getElementById("userDropdown").classList.toggle("show");
      document.getElementById("menuDropdown").classList.remove("show");
    }

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    window.onload = () => {
      // Disable back button after logout
      if (!sessionStorage.getItem("loggedIn")) {
        window.location.replace("index.html");
      }
    }

    window.onclick = function(event) {
      if (!event.target.matches('.menu-icon') && !event.target.closest('.menu-dropdown')) {
        document.getElementById("menuDropdown").classList.remove("show");
      }
      if (!event.target.closest('.user-icon') && !event.target.closest('.user-dropdown')) {
        document.getElementById("userDropdown").classList.remove("show");
      }
    }

    window.addEventListener("load", () => {
        document.getElementById("pageLoader").style.display = "none";
      });

      // Optional global control for Supabase calls
      function showLoader() {
        document.getElementById("pageLoader").style.display = "flex";
      }

      function hideLoader() {
        document.getElementById("pageLoader").style.display = "none";
      }

      
let sales = []; // this will be populated from your DB
let groupedSales = {};
let filteredQuery = "";
let rawSales = []; // always stores the latest fresh data



async function fetchSales() {
  const { data, error } = await supabase
    .from("sales") // your table name
    .select("*")
    .order("sale_date", { ascending: false }) // latest first
    .order("time_sold", { ascending: true }); // earliest sales in the day on top

  if (error) {
    console.error("Error fetching sales:", error);
    return;
  }

  // Convert to your structure
  sales = data.map(sale => ({
    item_name: sale.item_name,
    type: sale.item_type,
    quantity: sale.quantity,
    stock_amount: sale.stock_amount,
    price: sale.selling_amount,
    profit: sale.profit,
    payment_mode: sale.mode_of_payment,
    date: sale.sale_date,
    datetime: `${sale.sale_date}T${sale.time_sold}` // Combine to form full datetime
  }));

  rawSales = sales;
  groupSalesByDate();
  renderSales();
  return sales; 
}


function groupSalesByDate() {
  groupedSales = {};

  sales.forEach(sale => {
    const date = new Date(sale.datetime);
    const dayKey = date.toLocaleDateString("en-GB"); // e.g., "26/07/2025"
    const timeKey = date.toLocaleTimeString("en-GB"); // keeps full "HH:mm:ss"

    if (!groupedSales[dayKey]) groupedSales[dayKey] = {};
    if (!groupedSales[dayKey][timeKey]) groupedSales[dayKey][timeKey] = [];

    groupedSales[dayKey][timeKey].push(sale);
  });
}


function renderSales() {
  const container = document.getElementById("salesContainer");
  container.innerHTML = "";

  const sortedDays = Object.keys(groupedSales).sort((a, b) => {
    const [d1, m1, y1] = a.split("/").map(Number);
    const [d2, m2, y2] = b.split("/").map(Number);
    return new Date(y2, m2 - 1, d2) - new Date(y1, m1 - 1, d1);
  });

  sortedDays.forEach(day => {
    const dayBox = document.createElement("div");
    dayBox.className = "day-box";

    const dayHeader = document.createElement("div");
    dayHeader.className = "day-header";
    dayHeader.innerHTML = `<h2>${getDayName(day)} ${day}</h2>
      <button class="download-btn">Download Report</button>`;

    dayBox.appendChild(dayHeader);

    const timeBlocks = groupedSales[day];
    const sortedTimes = Object.keys(timeBlocks).sort();

    sortedTimes.forEach((time, index) => {
      const saleCard = document.createElement("div");
      saleCard.className = "sale-card";

      const saleHeader = document.createElement("div");
      saleHeader.className = "sale-header";
      saleHeader.innerHTML = `<span>Sale ${index + 1}</span><span>${time}</span>`;
      saleCard.appendChild(saleHeader);

      const tableWrapper = document.createElement("div");
tableWrapper.className = "sale-table-wrapper";

const table = document.createElement("table");
table.className = "sale-table";

const fields = ["Item", "Type", "Quantity", "Stock Amount", "Price", "Profit", "Payment"];
const fieldKeys = ["item_name", "type", "quantity", "stock_amount", "price", "profit", "payment_mode"];

// Create thead
const thead = document.createElement("thead");
const headerRow = document.createElement("tr");
fields.forEach(field => {
  const th = document.createElement("th");
  th.textContent = field;
  headerRow.appendChild(th);
});
thead.appendChild(headerRow);

// Create tbody
const tbody = document.createElement("tbody");
timeBlocks[time].forEach(sale => {
  const tr = document.createElement("tr");
  fieldKeys.forEach(key => {
    const td = document.createElement("td");
    td.textContent = sale[key];
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
});

table.appendChild(thead);
table.appendChild(tbody);
tableWrapper.appendChild(table);
saleCard.appendChild(tableWrapper);


      const footer = document.createElement("div");
      footer.className = "sale-footer";
      footer.innerHTML = `<button class="receipt-btn">Receipt</button>`;

      saleCard.appendChild(footer);
      dayBox.appendChild(saleCard);
    });

    const summary = calculateDailySummary(timeBlocks);
    const dayFooter = document.createElement("div");
dayFooter.className = "daily-footer";

// Create heading
const heading = document.createElement("h3");
heading.textContent = "Daily Calculations";
dayFooter.appendChild(heading);

// Create table
const summaryTable = document.createElement("table");
summaryTable.className = "summary-table";

// First row: Main titles
const titleRow = document.createElement("tr");
["Total Sales", "Stock Amount", "Profit"].forEach(title => {
  const th = document.createElement("th");
  th.colSpan = 2;
  th.textContent = title;
  titleRow.appendChild(th);
});
summaryTable.appendChild(titleRow);

// Second row: Combined totals (Cash + Mpesa)
const totalsRow = document.createElement("tr");
[
  summary.totalSales.cash + summary.totalSales.mpesa,
  summary.totalStock.cash + summary.totalStock.mpesa,
  summary.totalProfit.cash + summary.totalProfit.mpesa
].forEach(total => {
  const td = document.createElement("td");
  td.colSpan = 2;
  td.textContent = `${total}`;
  totalsRow.appendChild(td);
});
summaryTable.appendChild(totalsRow);

// Third row: Subheaders
const subHeaderRow = document.createElement("tr");
["Cash", "Mpesa", "Cash", "Mpesa", "Cash", "Mpesa"].forEach(label => {
  const th = document.createElement("th");
  th.textContent = label;
  subHeaderRow.appendChild(th);
});
summaryTable.appendChild(subHeaderRow);

// Fourth row: Sub-values
const valuesRow = document.createElement("tr");
[
  summary.totalSales.cash, summary.totalSales.mpesa,
  summary.totalStock.cash, summary.totalStock.mpesa,
  summary.totalProfit.cash, summary.totalProfit.mpesa
].forEach(amount => {
  const td = document.createElement("td");
  td.textContent = `${amount}`;
  valuesRow.appendChild(td);
});
summaryTable.appendChild(valuesRow);

// Append table to footer
const summaryWrapper = document.createElement("div");
summaryWrapper.className = "summary-wrapper"; // 👈 Give it a scrollable class
summaryWrapper.appendChild(summaryTable);

dayFooter.appendChild(summaryWrapper); // ⬅️ wrap this instead of table directly



    dayBox.appendChild(dayFooter);
    container.appendChild(dayBox);
  });
}

function getDayName(dateStr) {
  const [d, m, y] = dateStr.split("/").map(Number);
  const dayIndex = new Date(y, m - 1, d).getDay();
  return ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][dayIndex];
}

function renderSummaryColumn(title, data) {
  return `
    <div class="category">
      <h4>${title}</h4>
      <p>Cash: Ksh ${data.cash}</p>
      <p>Mpesa: Ksh ${data.mpesa}</p>
    </div>
  `;
}

function calculateDailySummary(salesByTime) {
  let totalSales = { cash: 0, mpesa: 0 };
  let totalStock = { cash: 0, mpesa: 0 };
  let totalProfit = { cash: 0, mpesa: 0 };

  Object.values(salesByTime).forEach(saleGroup => {
    saleGroup.forEach(sale => {
      const mode = sale.payment_mode.toLowerCase();
      totalSales[mode] += sale.price;
      totalStock[mode] += sale.stock_amount;
      totalProfit[mode] += sale.profit;
    });
  });

  return {
    totalSales,
    totalStock,
    totalProfit
  };
}

document.addEventListener("DOMContentLoaded", async () => {
  rawSales = await fetchSales(); // initial fetch
  groupSalesByDate(); // uses rawSales
  renderSales();      // render all

  const searchInput = document.getElementById("salesSearch");
  searchInput.addEventListener("input", e => {
    filteredQuery = e.target.value.trim().toLowerCase();
    filterSales(); // real-time filter
  });

  // Silent refresh
  setInterval(async () => {
    const latest = await fetchSales();
    rawSales = latest;
    groupSalesByDate(); // refresh groups

    if (filteredQuery) {
      filterSales(); // re-filter silently
    } else {
      renderSales(); // full refresh only if no active search
    }
  }, 10000); // every 10s
});

function filterSales() {
  const query = filteredQuery;

  const isDateLike = /\d{1,2}/.test(query); // numbers like "25"
  const isDayLike = /mon|tue|wed|thu|fri|sat|sun/i.test(query); // partial day match

  const filtered = rawSales.filter(sale => {
    const date = new Date(sale.datetime);
    const dayName = date.toLocaleDateString("en-GB", { weekday: "long" }).toLowerCase(); // e.g., "friday"
    const dateStr = date.toLocaleDateString("en-GB"); // e.g., 25/07/2025

    return (
      dateStr.includes(query) ||          // match partial date (25, 25/07, etc.)
      dayName.includes(query)             // match "fri", "friday", etc.
    );
  });

  groupedSales = {}; // reset
  filtered.forEach(sale => {
    const date = new Date(sale.datetime);
    const dayKey = date.toLocaleDateString("en-GB");
    const timeKey = date.toLocaleTimeString("en-GB", {
      hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
    });

    if (!groupedSales[dayKey]) groupedSales[dayKey] = {};
    if (!groupedSales[dayKey][timeKey]) groupedSales[dayKey][timeKey] = [];
    groupedSales[dayKey][timeKey].push(sale);
  });

  renderSales(); // only render filtered results
}
  </script>
</body>
</html>