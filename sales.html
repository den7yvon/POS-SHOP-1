<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POS | Sales</title>
  <link rel="shortcut icon" type="image/x-icon" href="Favicon.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {display: flex; font-family: 'Times New Roman', Times, serif; line-height: 1.4; min-height: 100vh;
      flex-direction: column; margin: 0; background-color: #f1f4f8;}

    .title {color: #003366; font-size: 24px; margin-bottom: 20px;}

    .main {background-color: white; border-radius: 15px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      padding: 25px; width: 90%; max-width: 400px; text-align: center;}

    .top-nav {width: 100%; height: 40px; background-color: #003366; color: white; display: flex;
      justify-content: space-between; align-items: center; padding: 0 15px; position: fixed;
      top: 0; z-index: 100;}
  
    .nav-left, .nav-center, .nav-right {display: flex; align-items: center; position: relative;}
  
    .menu-icon {font-size: 24px; cursor: pointer; margin-right: 10px;}
  
    .active-page {font-size: 16px; font-weight: 600;}
  
    .menu-dropdown {position: absolute; top: 40px; left: 0; background: white; color: #003366;
      border: 1px solid #ccc; border-radius: 6px; display: flex; flex-direction: column; width: 220px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);  overflow: hidden; z-index: 1000;  transform: scale(0);
      opacity: 0; transform-origin: top left; transition: transform 0.25s ease-out, opacity 0.2s ease-out;}
    
    .menu-dropdown a {padding: 10px; text-decoration: none; color: #003366; 
      border-bottom: 1px solid #eee; font-weight: 500;}
    
    .menu-dropdown a:hover {background-color: #f0f0f0;}
    
    .menu-dropdown.show { transform: scale(1); opacity: 1;}
    
    .nav-logo {font-size: 22px; font-weight: bold; margin-right: 70px;}

    .user-icon {cursor: pointer; margin-right: 0px;}
    
    .circle {width: 36px; height: 36px; background-color: white; border-radius: 50%; position: relative;
      display: flex; align-items: center; justify-content: center;}
    
    .head {width: 10px; height: 10px; background-color: #003366; border-radius: 50%;
      position: absolute; top: 8px;}
    
    .shoulders {width: 20px; height: 8px; background-color: #003366; border-radius: 50%; position: absolute;
      bottom: 8px;}

    .user-dropdown {position: absolute; top: 40px; right: 0; background: white;
      color: #003366; padding: 10px; border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1000; width: 160px; text-align: center; margin-right: 0px; transform-origin: top right;
      transform: scale(0); opacity: 0; transition: transform 0.25s ease-out, opacity 0.2s ease-out;
      display: block; pointer-events: none;}
    
    .user-dropdown.show {transform: scale(1); opacity: 1; pointer-events: auto;}
    
    .user-dropdown p {margin: 0 0 10px;}
    
    .user-dropdown button {background-color: #003366; color: white; border: none; padding: 8px 12px;
      border-radius: 4px; cursor: pointer; width: 90%;}
    
    .user-dropdown button:hover {background-color: #0055aa;}

    .main-content {margin-top: 30px; padding: 20px;}

    .foot {width: 100%; background-color: white; color: #003366; text-align: center; padding: 2px 1px;
      position: fixed; bottom: 0; left: 0; font-size: 15px;}

    #pageLoader {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9);
        z-index: 9999; display: flex; align-items: center; justify-content: center;}
  
    .spinner {border: 6px solid #ccc; border-top: 6px solid #2f0fe4; border-radius: 50%; width: 40px; height: 40px;
        animation: spin 1s linear infinite;}
  
    @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}

    * {margin: 0; padding: 0; box-sizing: border-box;}

    .sales-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;}

    .sales-header h1 {font-size: 24px;}

    #salesSearch {padding: 10px; width: min-content; border-radius: 6px; border: 1px solid #ccc;
      position: fixed; right: 10px; z-index: 50;}

    .day-box {background: white; border-radius: 12px; margin-bottom: 30px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.07); overflow: hidden;}

    .day-header {background: #003366; color: white; padding: 15px 20px; display: flex;
      justify-content: space-between; align-items: center;}

    .day-header h2 {font-size: 18px;}

    .download-btn {background: white; color: #003366; padding: 6px 12px; border: none;
      border-radius: 6px; font-weight: bold; cursor: pointer;}

    .download-btn:hover {background: #e1ecff;}

    .sale-card {position: relative; margin: 20px; padding: 15px 20px; border: 1px solid #ddd;
      border-radius: 10px; background: #fefefe; border-left: 6px solid #003366;
      overflow: hidden;}

    .sale-card::after {content: ""; position: absolute; top: 0; right: 0; width: 30%; height: 100%;
      background-image: linear-gradient(to left, rgba(255,255,255,0.8), rgba(255,255,255,0)),
      url('CardB.jpg'); background-size: cover; background-repeat: no-repeat; opacity: 0.2;
      pointer-events: none;}

    .sale-header {display: flex; justify-content: space-between; font-weight: bold;
      margin-bottom: 12px; color: #555;}

    .sale-footer {margin-top: 15px; text-align: right;}

    .receipt-btn {padding: 6px 14px; border: none; background: #003366; color: white;
      border-radius: 6px; cursor: pointer;}

    .receipt-btn:hover {background: #0055aa;}

    .daily-footer {background: #f0f0f0; padding: 20px; border-top: 1px solid #ccc;
      border-top: 6px solid #003366; border-bottom: 6px solid #003366;}

    .daily-footer h3 {text-align: center; margin-bottom: 15px;}

    .daily-totals {display: flex; justify-content: space-around; text-align: center; font-size: 14px;}

    .daily-totals .category {flex: 1;}

    .daily-totals .category h4 {margin-bottom: 8px; color: #007bff;}

    .sale-table-wrapper {overflow-x: auto; margin-top: 10px;}

    .sale-table {width: 100%; border-collapse: collapse; font-size: 14px; background: #fff;}

    .sale-table th,.sale-table td {padding: 10px; border: 1px solid #ccc; text-align: left;
      min-width: 100px;}

    .sale-table thead {background-color: #f4f4f4; font-weight: bold;}

    .sale-table tbody tr:nth-child(even) {background-color: #f9f9f9;}

    .summary-table {width: 100%; border-collapse: collapse; margin-top: 10px; text-align: center;
      font-size: 14px; background-color: #fff;}

    .summary-table th,.summary-table td {border: 1px solid #ccc; padding: 8px;}

    .summary-table th {background-color: #f4f4f4; font-weight: bold;}

    .summary-wrapper {overflow-x: auto; width: 100%;}

    .receipt-popup {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center; z-index: 9992;}

    .receipt-content {background: white; border: 10px solid limegreen; width: 90%; max-width: 600px;
      max-height: 70vh; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.3);
      font-family: 'Courier New', monospace; position: relative; display: flex;
      flex-direction: column; padding: 20px;}

    #receiptBody {flex: 1; overflow-y: auto; margin-bottom: 20px;}

    .receipt-actions {display: flex; justify-content: space-between; padding-top: 10px;}

    .receipt-actions button{  background-color: limegreen; cursor: pointer; border: limegreen; border-radius: 8px;
      padding: 4px 6px;}

    .receipt-actions button:hover{background-color: green;}

    .close-btn {position: absolute; top: 10px; right: 10px; font-size: 20px; cursor: pointer;
      background-color: transparent; border: transparent;}

    .hidden {display: none;}

    .skeleton-container {padding: 20px; display: flex; flex-direction: column; gap: 18px; align-items: center;}

    .skeleton-box {width: 100%; height: 90px; border-radius: 10px; background: linear-gradient(
        100deg,  #e0e0e0 20%,  #f5f5f5 40%,   #e0e0e0 60%);
        background-size: 200% 100%; animation: shimmer 1.4s infinite;}

        @keyframes shimmer {0% {background-position: -150% 0;} 100% {background-position: 150% 0;}}

    .loadingdata{font-size: 15px; font-weight: bold;}

    .hidden {display: none;}
  </style>
</head>
<body class="dashboard-page">
    <!-- Loader Spinner -->
    <div id="pageLoader">
      <div class="spinner"></div>
    </div>

  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="nav-left">
      <div class="menu-icon" onclick="toggleMenuDropdown()">‚ò∞</div>
      <span class="active-page" id="activePageName">Sales</span>
      <div class="menu-dropdown" id="menuDropdown">
        <a href="dashboard.html">‚û§ Dashboard</a>
        <a href="stock.html">‚û§ Stock</a>       
        <a href="expenses.html">‚û§ Expenses</a> 
        <a href="sales.html">‚û§ Sales Records</a>
        <a href="orders.html">‚û§ Orders Management</a>
        <a href="analysis.html">‚û§Analysis</a>
      </div>
    </div>

    <div class="nav-center">
      <span class="nav-logo">POS</span>
    </div>

    <div class="nav-right">
      <div class="user-icon" onclick="toggleUserDropdown()">
        <div class="circle">
          <div class="head"></div>
          <div class="shoulders"></div>
        </div>
      </div>
      <div class="user-dropdown" id="userDropdown">
        <p><strong>Piden Cyber, Electronics, Phones & Accessories</strong></p>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Content Area Placeholder -->
  <main class="main-content">
    <div class="sales-header">
      <h3>Records</h3>
      <input type="text" id="salesSearch" placeholder="üîçe.g. Day/Date" />
    </div>
  
            <!-- LOADING SKELETON AREA -->
            <div id="salesSkeleton" class="skeleton-container">
              <div class="skeleton-box"></div>
              <div class="skeleton-box"></div>
              <div class="loadingdata">Loading Data...</div>
              <div class="skeleton-box"></div>
              <div class="skeleton-box"></div>
            </div>

    <div id="salesContainer" class="hidden">
      <!-- Day containers with sales will be rendered here -->
    </div>

    <div id="receiptPopup" class="receipt-popup hidden">
      <div class="receipt-content">
        <button class="close-btn" onclick="closeReceiptPopup()">√ó</button>
        <div id="receiptBody">
          <p class="loading-text">Generating receipt...</p>
        </div>
        <div class="receipt-actions">
          <button onclick="printReceipt()">üñ®Ô∏è Print</button>
          <button onclick="downloadReceipt()">‚¨áÔ∏è Download</button>
        </div>
      </div>
    </div>    
  </main>

  <!-- Footer -->
  <footer class="foot">
    &copy; 2025 Piden Company Limited.
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Supabase JS Library (must come FIRST before you use supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Supabase Initialization -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const supabaseUrl = "https://mzvlybnvgpemdayoylfk.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16dmx5Ym52Z3BlbWRheW95bGZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MjkyODMsImV4cCI6MjA2MTAwNTI4M30.bRg54tsPook5UrfUM1p3y2WWkZqv_u7vbHpBGBKrQ4E";
    window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
    });
  </script>
  
  <!-- Inline JS for dropdowns & logout -->
  <script>
    function toggleMenuDropdown() {
      document.getElementById("menuDropdown").classList.toggle("show");
      document.getElementById("userDropdown").classList.remove("show");
    }

    function toggleUserDropdown() {
      document.getElementById("userDropdown").classList.toggle("show");
      document.getElementById("menuDropdown").classList.remove("show");
    }

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    window.onload = () => {
      // Disable back button after logout
      if (!sessionStorage.getItem("loggedIn")) {
        window.location.replace("index.html");
      }
    }

    window.onclick = function(event) {
      if (!event.target.matches('.menu-icon') && !event.target.closest('.menu-dropdown')) {
        document.getElementById("menuDropdown").classList.remove("show");
      }
      if (!event.target.closest('.user-icon') && !event.target.closest('.user-dropdown')) {
        document.getElementById("userDropdown").classList.remove("show");
      }
    }

    const skeleton = document.getElementById("salesSkeleton");
    const salesContainer = document.getElementById("salesContainer");

    window.addEventListener("load", () => {
        document.getElementById("pageLoader").style.display = "none";
          // Show skeleton, hide real contentq
          skeleton.classList.remove("hidden");
          salesContainer.classList.add("hidden");

        // Simulate loading for professionalism
        setTimeout(async () => {
          // first populate the UI with real data
          await fetchSales(); // wait until data is fully loaded and UI built

          // then hide skeleton and show the real content
          skeleton.classList.add("hidden");
          salesContainer.classList.remove("hidden");
        }, 2000); // 2 seconds loading simulation
      });

      // Optional global control for Supabase calls
      function showLoader() {
        document.getElementById("pageLoader").style.display = "flex";
      }

      function hideLoader() {
        document.getElementById("pageLoader").style.display = "none";
      }
      
      let sales = []; // this will be populated from your DB
      let groupedSales = {};
      let filteredQuery = "";
      let rawSales = []; // always stores the latest fresh data

      async function fetchSales() {
        const { data, error } = await supabase
          .from("sales") // your table name
          .select("*")
          .order("sale_date", { ascending: false }) // latest first
          .order("time_sold", { ascending: true }); // earliest sales in the day on top

        if (error) {
          console.error("Error fetching sales:", error);
          return;
        }

        // Convert to your structure
        sales = data.map(sale => ({
          item_name: sale.item_name,
          type: sale.item_type,
          quantity: sale.quantity,
          stock_amount: sale.stock_amount,
          price: sale.selling_amount,
          profit: sale.profit,
          payment_mode: sale.mode_of_payment,
          date: sale.sale_date,
          datetime: `${sale.sale_date}T${sale.time_sold}` // Combine to form full datetime
        }));

        rawSales = sales;
        groupSalesByDate();
        renderSales();
        return sales; 
      }

      function groupSalesByDate() {
        groupedSales = {};

        sales.forEach(sale => {
          const date = new Date(sale.datetime);
          const dayKey = date.toLocaleDateString("en-GB"); // e.g., "26/07/2025"
          const timeKey = date.toLocaleTimeString("en-GB"); // keeps full "HH:mm:ss"

          if (!groupedSales[dayKey]) groupedSales[dayKey] = {};
          if (!groupedSales[dayKey][timeKey]) groupedSales[dayKey][timeKey] = [];

          groupedSales[dayKey][timeKey].push(sale);
        });
      }

      function renderSales() {
        const container = document.getElementById("salesContainer");
        container.innerHTML = "";

        const sortedDays = Object.keys(groupedSales).sort((a, b) => {
          const [d1, m1, y1] = a.split("/").map(Number);
          const [d2, m2, y2] = b.split("/").map(Number);
          return new Date(y2, m2 - 1, d2) - new Date(y1, m1 - 1, d1);
        });

        if (sortedDays.length === 0) {
        const notFound = document.createElement("div");
        notFound.className = "not-found-message";
        notFound.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #555;">
            <div style="font-size: 100px;">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
            <div style="margin-top: 10px; font-size: 20px;">
              Oops! No sale records found for your search.
            </div>
          </div>
        `;
        container.appendChild(notFound);
        return;
      }

        sortedDays.forEach(day => {
          const dayBox = document.createElement("div");
          dayBox.className = "day-box";

          const dayHeader = document.createElement("div");
          dayHeader.className = "day-header";
          dayHeader.innerHTML = `<h2>${getDayName(day)} ${day}</h2>
            <button class="download-btn">Download Report</button>`;
            dayHeader.querySelector(".download-btn").addEventListener("click", () => {
        const summary = calculateDailySummary(timeBlocks);
        downloadSalesReport(day, timeBlocks, summary);
      });

          dayBox.appendChild(dayHeader);

          const timeBlocks = groupedSales[day];
          const sortedTimes = Object.keys(timeBlocks).sort();

          sortedTimes.forEach((time, index) => {
            const saleCard = document.createElement("div");
            saleCard.className = "sale-card";

            const saleHeader = document.createElement("div");
            saleHeader.className = "sale-header";
            saleHeader.innerHTML = `<span>Sale ${index + 1}</span><span>${time}</span>`;
            saleCard.appendChild(saleHeader);

            const tableWrapper = document.createElement("div");
      tableWrapper.className = "sale-table-wrapper";

      const table = document.createElement("table");
      table.className = "sale-table";

      const fields = ["Item", "Type", "Quantity", "Stock Amount", "Price", "Profit", "Payment"];
      const fieldKeys = ["item_name", "type", "quantity", "stock_amount", "price", "profit", "payment_mode"];

      // Create thead
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      fields.forEach(field => {
        const th = document.createElement("th");
        th.textContent = field;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      // Create tbody
      const tbody = document.createElement("tbody");
      timeBlocks[time].forEach(sale => {
        const tr = document.createElement("tr");
        fieldKeys.forEach(key => {
          const td = document.createElement("td");
          td.textContent = sale[key];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      tableWrapper.appendChild(table);
      saleCard.appendChild(tableWrapper);


            const footer = document.createElement("div");
            footer.className = "sale-footer";
            footer.innerHTML = `<button class="receipt-btn">Receipt</button>`;

            footer.querySelector(".receipt-btn").addEventListener("click", () => {
        openReceiptPopup(timeBlocks[time]);
      });

            saleCard.appendChild(footer);
            dayBox.appendChild(saleCard);
          });

          const summary = calculateDailySummary(timeBlocks);
          const dayFooter = document.createElement("div");
      dayFooter.className = "daily-footer";

      // Create heading
      const heading = document.createElement("h3");
      heading.textContent = "Daily Calculations";
      dayFooter.appendChild(heading);

      // Create table
      const summaryTable = document.createElement("table");
      summaryTable.className = "summary-table";

      // First row: Main titles
      const titleRow = document.createElement("tr");
      ["Total Sales", "Stock Amount", "Profit"].forEach(title => {
        const th = document.createElement("th");
        th.colSpan = 2;
        th.textContent = title;
        titleRow.appendChild(th);
      });
      summaryTable.appendChild(titleRow);

      // Second row: Combined totals (Cash + Mpesa)
      const totalsRow = document.createElement("tr");
      [
        summary.totalSales.cash + summary.totalSales.mpesa,
        summary.totalStock.cash + summary.totalStock.mpesa,
        summary.totalProfit.cash + summary.totalProfit.mpesa
      ].forEach(total => {
        const td = document.createElement("td");
        td.colSpan = 2;
        td.textContent = `${total}`;
        totalsRow.appendChild(td);
      });
      summaryTable.appendChild(totalsRow);

      // Third row: Subheaders
      const subHeaderRow = document.createElement("tr");
      ["Cash", "Mpesa", "Cash", "Mpesa", "Cash", "Mpesa"].forEach(label => {
        const th = document.createElement("th");
        th.textContent = label;
        subHeaderRow.appendChild(th);
      });
      summaryTable.appendChild(subHeaderRow);

      // Fourth row: Sub-values
      const valuesRow = document.createElement("tr");
      [
        summary.totalSales.cash, summary.totalSales.mpesa,
        summary.totalStock.cash, summary.totalStock.mpesa,
        summary.totalProfit.cash, summary.totalProfit.mpesa
      ].forEach(amount => {
        const td = document.createElement("td");
        td.textContent = `${amount}`;
        valuesRow.appendChild(td);
      });
      summaryTable.appendChild(valuesRow);

      // Append table to footer
      const summaryWrapper = document.createElement("div");
      summaryWrapper.className = "summary-wrapper"; // üëà Give it a scrollable class
      summaryWrapper.appendChild(summaryTable);

      dayFooter.appendChild(summaryWrapper); // ‚¨ÖÔ∏è wrap this instead of table directly



          dayBox.appendChild(dayFooter);
          container.appendChild(dayBox);
        });
      }

      function getDayName(dateStr) {
        const [d, m, y] = dateStr.split("/").map(Number);
        const dayIndex = new Date(y, m - 1, d).getDay();
        return ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][dayIndex];
      }

      function renderSummaryColumn(title, data) {
        return `
          <div class="category">
            <h4>${title}</h4>
            <p>Cash: Ksh ${data.cash}</p>
            <p>Mpesa: Ksh ${data.mpesa}</p>
          </div>
        `;
      }

      function calculateDailySummary(salesByTime) {
        let totalSales = { cash: 0, mpesa: 0 };
        let totalStock = { cash: 0, mpesa: 0 };
        let totalProfit = { cash: 0, mpesa: 0 };

        Object.values(salesByTime).forEach(saleGroup => {
          saleGroup.forEach(sale => {
            const mode = sale.payment_mode.toLowerCase();
            totalSales[mode] += sale.price;
            totalStock[mode] += sale.stock_amount;
            totalProfit[mode] += sale.profit;
          });
        });

        return {
          totalSales,
          totalStock,
          totalProfit
        };
      }

      document.addEventListener("DOMContentLoaded", async () => {
        rawSales = await fetchSales(); // initial fetch
        groupSalesByDate(); // uses rawSales
        renderSales();      // render all

        const searchInput = document.getElementById("salesSearch");
        searchInput.addEventListener("input", e => {
          filteredQuery = e.target.value.trim().toLowerCase();
          filterSales(); // real-time filter
        });

        // Silent refresh
        setInterval(async () => {
          const latest = await fetchSales();
          rawSales = latest;
          groupSalesByDate(); // refresh groups

          if (filteredQuery) {
            filterSales(); // re-filter silently
          } else {
            renderSales(); // full refresh only if no active search
          }
        }, 10000); // every 10s
      });

      function filterSales() {
        const query = filteredQuery;

        const isDateLike = /\d{1,2}/.test(query); // numbers like "25"
        const isDayLike = /mon|tue|wed|thu|fri|sat|sun/i.test(query); // partial day match

        const filtered = rawSales.filter(sale => {
          const date = new Date(sale.datetime);
          const dayName = date.toLocaleDateString("en-GB", { weekday: "long" }).toLowerCase(); // e.g., "friday"
          const dateStr = date.toLocaleDateString("en-GB"); // e.g., 25/07/2025

          return (
            dateStr.includes(query) ||          // match partial date (25, 25/07, etc.)
            dayName.includes(query)             // match "fri", "friday", etc.
          );
        });

        groupedSales = {}; // reset
        filtered.forEach(sale => {
          const date = new Date(sale.datetime);
          const dayKey = date.toLocaleDateString("en-GB");
          const timeKey = date.toLocaleTimeString("en-GB", {
            hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
          });

          if (!groupedSales[dayKey]) groupedSales[dayKey] = {};
          if (!groupedSales[dayKey][timeKey]) groupedSales[dayKey][timeKey] = [];
          groupedSales[dayKey][timeKey].push(sale);
        });

        renderSales(); // only render filtered results
      }

      function openReceiptPopup(salesList) {
        const popup = document.getElementById("receiptPopup");
        const body = document.getElementById("receiptBody");
        popup.classList.remove("hidden");

        // Loading state
        body.innerHTML = `<p class="loading-text">Generating receipt...</p>`;

        setTimeout(() => {
          const paymentMode = salesList[0].payment_mode || "N/A";
          const firstSaleDate = new Date(salesList[0].datetime);
      const dayName = firstSaleDate.toLocaleDateString("en-GB", { weekday: "long" }); // e.g., Saturday
      const dateOnly = firstSaleDate.toLocaleDateString("en-GB"); // e.g., 29/07/2025
      const timeOnly = firstSaleDate.toLocaleTimeString("en-GB", {
        hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
      }); // e.g., 11:08:05

          let grandTotal = 0;

          let receiptHTML = `
            <div style="text-align: center;">
              <h2>PIDEN CYBER & ELECTRONICS</h2>
              <p>P.O. Box 10-10226, Kambiti</p>
              <p>Murang'a, Kenya</p>
              <p>Tel: +254-748-408498</p>
              <p>The home of Cyber Services, Electronics, Mobile Phones and accessories.</p>
              <h2>RECEIPT</h2>
            </div>
            <hr style="margin: 10px 0;" />
            <table style="width:100%; border-collapse: collapse; font-size: 14px;">
              <thead>
                <tr>
                  <th style="text-align: left; padding: 8px;">Qty</th>
                  <th style="text-align: left; padding: 8px;">Item</th>
                  <th style="text-align: right; padding: 8px;">Unit Price</th>
                  <th style="text-align: right; padding: 8px;">Total</th>
                </tr>
              </thead>
              <tbody>`;

          salesList.forEach(sale => {
            const total = Number(sale.price); // already total price
            const unitPrice = total / Number(sale.quantity); // correct unit price
            grandTotal += total;

            receiptHTML += `
              <tr>
                <td style="text-align: left; padding: 8px;">${sale.quantity}</td>
                <td style="text-align: left; padding: 8px;">${sale.item_name}</td>
                <td style="text-align: right; padding: 8px;">${unitPrice.toFixed(2)}</td>
                <td style="text-align: right; padding: 8px;">${total.toFixed(2)}</td>
              </tr>`;
          });

          receiptHTML += `
              </tbody>
            </table>

            <hr style="margin: 10px 0;" />
            <p style="text-align: Left; font-size: 16px; font-weight: bold;">Total: Ksh. ${grandTotal.toFixed(2)}</p>
            <p><strong>Payment Mode:</strong> ${paymentMode}</p>
            <p><strong>Day:</strong> ${dayName} | <strong>Date:</strong> ${dateOnly} | <strong>Time:</strong> ${timeOnly}</p>
            <hr style="margin: 10px 0;" />
            <p style="text-align:center; margin-top: 20px;">Thank you and welcome again!</p>`;

          body.innerHTML = receiptHTML;
        }, 500);
      }

      function closeReceiptPopup() {
        document.getElementById("receiptPopup").classList.add("hidden");
      }

      function printReceipt() {
        const content = document.getElementById("receiptBody").innerHTML;
        const win = window.open('', '', 'height=600,width=400');
        win.document.write('<html><head><title>Receipt</title></head><body>');
        win.document.write(content);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
      }

      function downloadReceipt() {
        showLoader();
        const source = document.getElementById("receiptBody");        

        const clone = source.cloneNode(true);
        clone.style.maxHeight = 'none';
        clone.style.overflow = 'visible';

        const hiddenWrapper = document.createElement("div");
        hiddenWrapper.style.position = "absolute";
        hiddenWrapper.style.left = "-9999px";
        hiddenWrapper.appendChild(clone);
        document.body.appendChild(hiddenWrapper);

        const opt = {
          margin: 0.5,
          filename: `Receipt_${new Date().toISOString().slice(0,10)}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: {
            scale: 2,
            useCORS: true,
            scrollY: 0
          },
          jsPDF: {
            unit: 'in',
            format: 'a4',
            orientation: 'portrait'
          }
        };

        html2pdf().set(opt).from(clone).save()
          .then(() => {
            // successful
            document.body.removeChild(hiddenWrapper);
          })
          .catch(err => {
            console.error("PDF generation failed:", err);
          })
          .finally(() => {
            hideLoader(); // always called
          });
      }

      function downloadSalesReport(day, salesByTime, summary) {
        showLoader();

        // Create container
        const reportWrapper = document.createElement("div");
        reportWrapper.style.padding = "20px";
        reportWrapper.style.fontFamily = "Times New Roman, sans-serif";

        // HEADER
        const header = document.createElement("div");
        header.style.backgroundColor = "#003366"; 
        header.style.textAlign = "center";
        header.style.borderTopLeftRadius = "10px";
        header.style.borderTopRightRadius = "10px";
        header.innerHTML = `<h2 style="margin-bottom: 5px; color:white;">SALES REPORT</h2>`;

        const dayDateRow = document.createElement("div");
        dayDateRow.style.display = "flex";
        dayDateRow.style.borderBottomLeftRadius = "10px";
        dayDateRow.style.borderBottomRightRadius = "10px";
        dayDateRow.style.justifyContent = "space-between";
        dayDateRow.style.background = "#003366";
        dayDateRow.style.color = "White";
        dayDateRow.style.padding = "5px 10px";
        dayDateRow.style.marginBottom = "20px";
        const dayName = getDayName(day);
        dayDateRow.innerHTML = `<span><strong>DAY:</strong> ${dayName}</span><span><strong>DATE:</strong> ${day}</span>`;

        reportWrapper.appendChild(header);
        reportWrapper.appendChild(dayDateRow);

        // BODY (Sales Cards)
        const sortedTimes = Object.keys(salesByTime).sort();
        sortedTimes.forEach((time, index) => {
          const saleCard = document.createElement("div");
          saleCard.style.border = "1px solid #ccc";
          saleCard.style.borderLeft = "6px solid #003366";
          saleCard.style.borderRadius = "10px";
          saleCard.style.marginBottom = "15px";
          saleCard.style.padding = "10px";

          const header = document.createElement("div");
          header.style.display = "flex";
          header.style.justifyContent = "space-between";
          header.style.marginBottom = "8px";
          header.innerHTML = `<strong>Sale ${index + 1}</strong><span>${time}</span>`;
          saleCard.appendChild(header);

          const table = document.createElement("table");
          table.style.width = "100%";
          table.style.borderCollapse = "collapse";
          table.style.marginBottom = "10px";

          const fields = ["Item", "Type", "Quantity", "Stock Amount", "Price", "Profit", "Payment"];
          const fieldKeys = ["item_name", "type", "quantity", "stock_amount", "price", "profit", "payment_mode"];

          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");
          fields.forEach(field => {
            const th = document.createElement("th");
            th.textContent = field;
            th.style.border = "1px solid #ddd";
            th.style.padding = "5px";
            th.style.background = "#f9f9f9";
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          salesByTime[time].forEach(sale => {
            const tr = document.createElement("tr");
            fieldKeys.forEach(key => {
              const td = document.createElement("td");
              td.textContent = sale[key];
              td.style.border = "1px solid #ddd";
              td.style.padding = "5px";
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });

          table.appendChild(tbody);
          saleCard.appendChild(table);
          reportWrapper.appendChild(saleCard);
        });

        // FOOTER (Daily Summary)
        const footer = document.createElement("div");
        footer.style.background = "#f2f2f2"; // Light gray background for the section
      footer.style.padding = "10px";
      footer.style.borderRadius = "10px";
        footer.innerHTML = `
          <h3 style="text-align:center; margin: 20px 0 10px;background-color:#003366; color:white; padding:8px; 
          border-top-right-radius:10px; border-top-left-radius:10px;">Daily Calculations</h3>
          <table style="width: 100%; border-collapse: collapse; border-top: 6px solid #003366; 
          border-bottom: 6px solid #003366;">
            <tr>
              <th colspan="2" style="border: 1px solid #ccc; padding: 5px;">Total Sales</th>
              <th colspan="2" style="border: 1px solid #ccc; padding: 5px;">Stock Amount</th>
              <th colspan="2" style="border: 1px solid #ccc; padding: 5px;">Profit</th>
            </tr>
            <tr>
              <td colspan="2" style="border: 1px solid #ccc; padding: 5px; text-align: center;">
                ${summary.totalSales.cash + summary.totalSales.mpesa}
              </td>
              <td colspan="2" style="border: 1px solid #ccc; padding: 5px; text-align: center;">
                ${summary.totalStock.cash + summary.totalStock.mpesa}
              </td>
              <td colspan="2" style="border: 1px solid #ccc; padding: 5px; text-align: center;">
                ${summary.totalProfit.cash + summary.totalProfit.mpesa}
              </td>
            </tr>
            <tr>
              <th style="border: 1px solid #ccc; padding: 5px;">Cash</th>
              <th style="border: 1px solid #ccc; padding: 5px;">Mpesa</th>
              <th style="border: 1px solid #ccc; padding: 5px;">Cash</th>
              <th style="border: 1px solid #ccc; padding: 5px;">Mpesa</th>
              <th style="border: 1px solid #ccc; padding: 5px;">Cash</th>
              <th style="border: 1px solid #ccc; padding: 5px;">Mpesa</th>
            </tr>
            <tr>
              <td style="border: 1px solid #ccc; padding: 5px; text-align: center;">${summary.totalSales.cash}</td>
              <td style="border: 1px solid #ccc; padding: 5px; text-align: center;">${summary.totalSales.mpesa}</td>
              <td style="border: 1px solid #ccc; padding: 5px; text-align: center;">${summary.totalStock.cash}</td>
              <td style="border: 1px solid #ccc; padding: 5px; text-align: center;">${summary.totalStock.mpesa}</td>
              <td style="border: 1px solid #ccc; padding: 5px; text-align: center;">${summary.totalProfit.cash}</td>
              <td style="border: 1px solid #ccc; padding: 5px; text-align: center;">${summary.totalProfit.mpesa}</td>
            </tr>
          </table>
        `;
        reportWrapper.appendChild(footer);

        // Wrap and render to PDF
        const hiddenWrapper = document.createElement("div");
        hiddenWrapper.style.position = "absolute";
        hiddenWrapper.style.left = "-9999px";
        hiddenWrapper.appendChild(reportWrapper);
        document.body.appendChild(hiddenWrapper);

        html2pdf()
          .set({
            margin: 0.5,
            filename: `Sales_Report_${day.replaceAll("/", "-")}.pdf`,
            image: { type: 'png', quality: 1 },
            html2canvas: { scale: 4, useCORS: true, scrollY: 0 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: 'avoid-all', before: '.sale-card' } // prevents mid-breaks
          })
          .from(reportWrapper)
          .save()
          .then(() => {
            document.body.removeChild(hiddenWrapper);
            hideLoader();
          });
      }
  </script>
</body>
</html>