<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POS | Expenses</title>
  <link rel="shortcut icon" type="image/x-icon" href="Favicon.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {display: flex; font-family: 'Times New Roman', Times, serif; line-height: 1.4; min-height: 100vh;
      flex-direction: column; margin: 0; background-color: #f1f4f8;}

    .title {color: #003366; font-size: 24px; margin-bottom: 20px;}

    .main {background-color: white; border-radius: 15px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      padding: 25px; width: 90%; max-width: 400px; text-align: center;}

    .top-nav {width: 100%; height: 40px; background-color: #003366; color: white; display: flex;
      justify-content: space-between; align-items: center; padding: 0 15px; position: fixed;
      top: 0; z-index: 100;}
  
    .nav-left, .nav-center, .nav-right {display: flex; align-items: center; position: relative;}
  
    .menu-icon {font-size: 24px; cursor: pointer; margin-right: 10px;}
  
    .active-page {font-size: 16px; font-weight: 600;}
  
    .menu-dropdown {position: absolute; top: 40px; left: 0; background: white; color: #003366;
      border: 1px solid #ccc; border-radius: 6px; display: none; flex-direction: column; width: 220px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);  overflow: hidden; z-index: 1000;}
    
    .menu-dropdown a {padding: 10px; text-decoration: none; color: #003366; 
      border-bottom: 1px solid #eee; font-weight: 500;}
    
    .menu-dropdown a:hover {background-color: #f0f0f0;}
    
    .menu-dropdown.show {display: flex;}
    
    .nav-logo {font-size: 22px; font-weight: bold; margin-right: 70px;}

    .user-icon {cursor: pointer; margin-right: 30px;}
    
    .circle {width: 36px; height: 36px; background-color: white; border-radius: 50%; position: relative;
      display: flex; align-items: center; justify-content: center;}
    
    .head {width: 10px; height: 10px; background-color: #003366; border-radius: 50%;
      position: absolute; top: 8px;}
    
    .shoulders {width: 20px; height: 8px; background-color: #003366; border-radius: 50%; position: absolute;
      bottom: 8px;}

    .user-dropdown {position: absolute; top: 40px; right: 0; background: white;
      color: #003366; padding: 10px; border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      display: none; z-index: 1000; width: 160px; text-align: center;}
    
    .user-dropdown.show {display: block;}
    
    .user-dropdown p {margin: 0 0 10px;}
    
    .user-dropdown button {background-color: #003366; color: white; border: none; padding: 8px 12px;
      border-radius: 4px; cursor: pointer; width: 90%;}
    
    .user-dropdown button:hover {background-color: #0055aa;}

    .main-content {margin-top: 0px; padding: 20px;}

    .foot {width: 100%; background-color: #003366; color: white; text-align: center; padding: 2px 1px;
      position: fixed; bottom: 0; left: 0; font-size: 10px;}

    #pageLoader {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9);
        z-index: 9999; display: flex; align-items: center; justify-content: center;}
  
    .spinner {border: 6px solid #ccc; border-top: 6px solid #2f0fe4; border-radius: 50%; width: 40px; height: 40px;
        animation: spin 1s linear infinite;}
  
    @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}

/* Expenses Home Styles */
.expenses-home {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 0px; /* pushes below top bar */
}

.welcome-message {
  font-size: 20px;
  color: Black;
  font-weight: 600;
  margin-bottom: 0px;
  text-align: center;
}

/* Button Styles */
.expense-btn {
  background-color: #003366;
  color: white;
  padding: 12px 25px;
  margin: 10px 0;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  width: 200px;
  transition: background-color 0.3s ease;
  opacity: 0; /* start hidden for animation */
  transform: translateY(50px); /* start lower for animation */
}

.expense-btn:hover {
  background-color: #0055aa;
}

/* Slide Up Animation */
.slide-up.show {
  animation: slideUp 0.6s ease forwards;
}

@keyframes slideUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Popup Overlay */
.popup-overlay {
  position: fixed;
  left: 0;
  bottom: -100%;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: bottom 0.4s ease;
  z-index: 2000;
}

/* Show Popup */
.popup-overlay.show {
  bottom: 0;
}

/* Popup Content */
.popup-content {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 300px;
  overflow: hidden;
  animation: slideUpPopup 0.4s ease;
}

/* Popup Slide Animation */
@keyframes slideUpPopup {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Header */
.popup-header {
  background-color: #003366;
  color: white;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.popup-title {
  font-size: 18px;
  font-weight: bold;
}

.popup-close {
  cursor: pointer;
  font-size: 20px;
}

/* Body */
.popup-body {
  padding: 15px;
}

.popup-body label {
  display: block;
  font-weight: 600;
  margin-top: 5px;
  margin-bottom: 4px;
}

.popup-body input,
.popup-body select {
  width: 95%;
  padding: 8px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-bottom: 8px;
}

/* Footer */
.popup-footer {
  padding: 15px;
  text-align: center;
}

#completeExpenseBtn {
  background-color: #003366;
  color: white;
  border: none;
  padding: 10px 20px;
  width: 80%;
  font-size: 15px;
  border-radius: 10px;
  cursor: pointer;
}

#completeExpenseBtn:hover {
  background-color: #0055aa;
}


.checkmark {width: 80px; height: 80px; stroke: #003366; stroke-width: 4; stroke-linecap: round;
      stroke-linejoin: round; stroke-miterlimit: 10; animation: drawCircle 0.6s ease-in-out forwards;
      display: block; overflow: visible; box-sizing: content-box;}

    .checkmark-circle {stroke-dasharray: 166; stroke-dashoffset: 166;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;}

    .checkmark-check {stroke-dasharray: 48; stroke-dashoffset: 48;
      animation: stroke 0.3s 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;}

    @keyframes stroke {to {stroke-dashoffset: 0;}}

    @keyframes drawCircle {0% {transform: scale(0); opacity: 0;} 100% {transform: scale(1); opacity: 1;}}

    .tick-animation {display: flex; justify-content: center; align-items: center; margin: 20px 0;}

    .overlay {position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 9990;}

    .hidden {display: none;}

    .popup-content.small {width: 300px; padding: 5px 5px; text-align: center; align-items: center;}

    .popup-buttons button.edit-back{background-color: #003366; color: white; cursor: pointer; width: 50%;
      font-weight: bold; margin-bottom: 10px;}

.popup-buttons button.edit-back:hover{background-color: #0055aa;}

.popup-buttons button {margin: 10px 5px 0; padding: 10px 15px; border: none; border-radius: 6px;
      font-weight: bold; cursor: pointer;}

      /* View Expenses Layout */
.view-expenses-section {
  margin-top: 50px;
  padding: 15px;
}

/* Day Box */
.day-box {
  background: white;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  overflow: hidden;
}

/* Day Header */
.day-header {
  background-color: #003366;
  color: white;
  display: flex;
  justify-content: space-between;
  padding: 10px 15px;
  align-items: center;
}

.day-header h3 {
  margin: 0;
  font-size: 16px;
}

.download-btn {
  background-color: white;
  color: #003366;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.download-btn:hover {
  background-color: #86e0f0;
}

/* Expenses Cards Container */
.expenses-cards {
  display: flex;
  overflow-x: auto;
  padding: 10px;
  gap: 15px;
}

.expenses-cards::-webkit-scrollbar {
  height: 6px;
}
.expenses-cards::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 3px;
}

/* Expense Card */
.expense-card {
  flex: 0 0 270px;
  background: white;
  border-radius: 10px;
  border-left: 4px solid #003366;
  position: relative;
  padding: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.expense-card h4 {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
}

.expense-time {
  font-size: 12px;
  color: gray;
  position: absolute;
  top: 12px;
  right: 12px;
}

/* Background faded image */
.expense-bg {
  position: absolute;
  top: 0;
  right: 0;
  width: 60%;
  height: 100%;
  background-image: url('CardB.jpg');
  background-size: cover;
  background-repeat: no-repeat;
  opacity: 0.1;
  pointer-events: none;
}

/* Table inside expense card */
.expense-card table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 25px;
}

.expense-card th,
.expense-card td {
  text-align: left;
  padding: 4px;
  font-size: 13px;
}

/* Daily Calculations Footer */
.daily-footer {
  background-color: #f1f4f8;
  padding: 10px;
  border-top: 1px solid #ddd;
  border-bottom: 6px solid #003366;
}

.daily-footer h4 {
  margin: 0 0 8px;
  font-size: 14px;
  font-weight: bold;
  border-bottom: 1px solid #ddd;
}

.daily-footer table {
  width: 100%;
  border-collapse: collapse;
}

/* Add vertical separators between columns */
.daily-footer th,
.daily-footer td {
  text-align: center;
  padding: 4px;
  font-size: 13px;
  border-right: 1px solid #ccc; /* Separator */
}

/* Remove the last column's right border */
.daily-footer th:last-child,
.daily-footer td:last-child {
  border-right: none;
}

.sales-search {
  position: fixed;
  top: 45px;
  right: 20px;
  z-index: 1000;
}

.sales-search input {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
}

#noResults {
  text-align: center;
  margin-top: 40px;
  color: #777;
}

.officer-emoji {
  font-size: 100px;
  margin-bottom: 10px;
}

.hidden {
  display: none;
}

.records-heading {
  font-size: 1.2rem;
  font-weight: bold;
  margin: 1px 0;
  color: #333;
  position: absolute;
  top: 45px;
  left: 20px;
}

.back{background-color: transparent; border: transparent; font-weight: bold; font-size: medium;
cursor: pointer;}
  </style>
</head>
<body class="dashboard-page">
    <!-- Loader Spinner -->
    <div id="pageLoader">
      <div class="spinner"></div>
    </div>

  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="nav-left">
      <div class="menu-icon" onclick="toggleMenuDropdown()">‚ò∞</div>
      <span class="active-page" id="activePageName">Expenses</span>
      <div class="menu-dropdown" id="menuDropdown">
        <a href="dashboard.html">‚û§ Dashboard</a>
        <a href="stock.html">‚û§ Stock</a>       
        <a href="expenses.html">‚û§ Expenses</a> 
        <a href="sales.html">‚û§ Sales Records</a>
        <a href="orders.html">‚û§ Orders Management</a>
        <a href="analysis.html">‚û§Analysis</a>
      </div>
    </div>

    <div class="nav-center">
      <span class="nav-logo">POS</span>
    </div>

    <div class="nav-right">
      <div class="user-icon" onclick="toggleUserDropdown()">
        <div class="circle">
          <div class="head"></div>
          <div class="shoulders"></div>
        </div>
      </div>
      <div class="user-dropdown" id="userDropdown">
        <p><strong>Piden Electronics</strong></p>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Content Area Placeholder -->
  <main class="main-content">
<main class="main-content expenses-home">
  <h2 class="welcome-message">Welcome to the Expenses Section</h2>
  <button class="expense-btn add-expense-btn slide-up">‚ûï Add Expense</button>
  <button class="expense-btn view-expense-btn slide-up">üìÑ View Expenses</button>
</main>

<!-- Add Expense Popup -->
<div class="popup-overlay" id="addExpensePopup">
  <div class="popup-content">
    <!-- Header -->
    <div class="popup-header">
      <span class="popup-title">Add Expense</span>
      <span class="popup-close" id="closeAddExpense">&times;</span>
    </div>

    <!-- Input Fields -->
    <div class="popup-body">
      <label>Expense Description</label>
      <input type="text" id="expenseDetails" placeholder="Enter expense details">

      <label>Amount Used</label>
      <input type="number" id="expenseAmount" placeholder="Enter amount">

      <label>Payment Mode</label>
      <select id="paymentMode">
        <option value="">Select Mode</option>
        <option value="Cash">Cash</option>
        <option value="Mpesa">Mpesa</option>
      </select>
    </div>

    <!-- Complete Button -->
    <div class="popup-footer">
      <button id="completeExpenseBtn">Complete</button>
    </div>
  </div>
</div>

<div id="successEditPopup" class="overlay hidden">
  <div class="popup-content small">
    <h2>Expense Added Successfully!</h2>
    <div class="tick-animation">
      <svg class="checkmark" viewBox="0 0 52 52">
        <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
        <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17"/>
      </svg>
    </div>
    <div class="popup-buttons">
      <button class="edit-back" onclick="returnToEditOptions()">Done</button>
    </div>
  </div>
</div>


<!-- Expenses List Section -->
<section class="view-expenses-section" id="viewExpensesSection" style="display:none;">
  <h4 class="records-heading"><a href="expenses.html"><button class="back">‚Æú</button></a> Records</h4>
  <div id="expensesContainer"></div>
  <!-- Search bar -->
<div class="sales-search">
  <input type="text" id="salesSearch" placeholder="üîçe.g. Day/Date"/>
</div>

<!-- No results visual -->
<div id="noResults" class="hidden">
  <div class="officer-emoji">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
  <p>Oops! No Expense report found from your search</p>
</div>

</section>

  </main>

  <!-- Footer -->
  <footer class="foot">
    &copy; 2025 Piden Company Limited.
  </footer>

  <!-- Supabase JS Library (must come FIRST before you use supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Supabase Initialization -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const supabaseUrl = "https://mzvlybnvgpemdayoylfk.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16dmx5Ym52Z3BlbWRheW95bGZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MjkyODMsImV4cCI6MjA2MTAwNTI4M30.bRg54tsPook5UrfUM1p3y2WWkZqv_u7vbHpBGBKrQ4E";
    window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
    });
  </script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- Inline JS for dropdowns & logout -->
  <script>
    function toggleMenuDropdown() {
      document.getElementById("menuDropdown").classList.toggle("show");
      document.getElementById("userDropdown").classList.remove("show");
    }

    function toggleUserDropdown() {
      document.getElementById("userDropdown").classList.toggle("show");
      document.getElementById("menuDropdown").classList.remove("show");
    }

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    window.onload = () => {
      // Disable back button after logout
      if (!sessionStorage.getItem("loggedIn")) {
        window.location.replace("index.html");
      }
    }

    window.onclick = function(event) {
      if (!event.target.matches('.menu-icon') && !event.target.closest('.menu-dropdown')) {
        document.getElementById("menuDropdown").classList.remove("show");
      }
      if (!event.target.closest('.user-icon') && !event.target.closest('.user-dropdown')) {
        document.getElementById("userDropdown").classList.remove("show");
      }
    }

    window.addEventListener("load", () => {
        document.getElementById("pageLoader").style.display = "none";
      });

      // Optional global control for Supabase calls
      function showLoader() {
        document.getElementById("pageLoader").style.display = "flex";
      }

      function hideLoader() {
        document.getElementById("pageLoader").style.display = "none";
      }

  // Slide-up animation trigger
window.addEventListener("load", () => {
  document.querySelectorAll(".slide-up").forEach((btn, index) => {
    setTimeout(() => {
      btn.classList.add("show");
    }, index * 200); // stagger animation
  });
});

// Buttons functionality placeholder
document.querySelector(".add-expense-btn").addEventListener("click", () => {
  addExpensePopup.classList.add("show");
});

document.querySelector(".view-expense-btn").addEventListener("click", () => {
  welcomeSection.style.display = "none";
  viewSection.style.display = "block";
  fetchExpenses();
});

// References
const viewExpenseBtn = document.querySelector(".view-expense-btn");
const welcomeSection = document.querySelector(".expenses-home");
const viewSection = document.getElementById("viewExpensesSection");
const expensesContainer = document.getElementById("expensesContainer");
const addExpenseBtn = document.querySelector(".add-expense-btn");
const addExpensePopup = document.getElementById("addExpensePopup");
const closeAddExpense = document.getElementById("closeAddExpense");
const completeExpenseBtn = document.getElementById("completeExpenseBtn");


// Close popup & clear fields
function closeAndClearPopup() {
  addExpensePopup.classList.remove("show");
  document.getElementById("expenseDetails").value = "";
  document.getElementById("expenseAmount").value = "";
  document.getElementById("paymentMode").value = "";
}

closeAddExpense.addEventListener("click", closeAndClearPopup);

// Insert into Supabase
completeExpenseBtn.addEventListener("click", async () => {
  const details = document.getElementById("expenseDetails").value.trim();
  const amount = document.getElementById("expenseAmount").value.trim();
  const mode = document.getElementById("paymentMode").value;
  
  // Validation
  if (!details || !amount || !mode) {
    alert("Please fill in all fields.");
    return;
  }

  // Today's date in dd/mm/yyyy
  const today = new Date();
  const date = today.toLocaleDateString("en-GB");

  try {
    showLoader();
    // Insert into Supabase
    const { error } = await supabase
      .from("expenses")
      .insert([
        { details, amount: parseFloat(amount), mode, date, created_at: new Date().toISOString() }
      ]);

    if (error) throw error;

      hideLoader(); 
      showSuccessEditPopup(); 
  } catch (err) {
    console.error("Error adding expense:", err.message);
    alert("Error adding expense. Check console for details.");
    hideLoader();
  }
});

function showSuccessEditPopup() {
        document.getElementById("successEditPopup").classList.remove("hidden");
      }

      function returnToEditOptions() {
        document.getElementById("successEditPopup").classList.add("hidden");
        closeAndClearPopup();
      }

      let allExpenses = []; 
// Fetch and render expenses
async function fetchExpenses() {
  const { data, error } = await supabase
    .from("expenses")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Error fetching expenses:", error);
    return;
  }
  allExpenses = data; 
  renderExpenses(data);
}

// Render expenses grouped by date
function renderExpenses(expenses) {
  expensesContainer.innerHTML = "";

  // Group by date
  const grouped = expenses.reduce((acc, exp) => {
    const dateKey = exp.date;
    if (!acc[dateKey]) acc[dateKey] = [];
    acc[dateKey].push(exp);
    return acc;
  }, {});

  Object.keys(grouped)
    .sort((a, b) => {
      const [d1, m1, y1] = a.split("/").map(Number);
      const [d2, m2, y2] = b.split("/").map(Number);
      return new Date(y2, m2 - 1, d2) - new Date(y1, m1 - 1, d1);
    })
    .forEach(dateKey => {
      const dayName = new Date(dateKey.split("/").reverse().join("-"))
        .toLocaleDateString("en-GB", { weekday: "long" });
      const dailyExpenses = grouped[dateKey].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

      // Calculate totals
      let total = 0, cashTotal = 0, mpesaTotal = 0;
      dailyExpenses.forEach(exp => {
        total += exp.amount;
        if (exp.mode === "Cash") cashTotal += exp.amount;
        if (exp.mode === "Mpesa") mpesaTotal += exp.amount;
      });

      // Create day box
      const dayBox = document.createElement("div");
      dayBox.className = "day-box";
      dayBox.dataset.day = dayName.toLowerCase();
dayBox.dataset.date = dateKey.toLowerCase();

      dayBox.innerHTML = `
        <div class="day-header">
          <h3>${dayName} ${dateKey}</h3>
          <button class="download-btn" onclick="downloadReport('${dateKey}')">Download Report</button>
        </div>
        <div class="expenses-cards">
          ${dailyExpenses.map((exp, idx) => `
            <div class="expense-card">
              <h4>Expense ${idx + 1}</h4>
              <span class="expense-time">${new Date(exp.created_at).toLocaleTimeString()}</span>
              <div class="expense-bg"></div>
              <table>
                <tr><th>Description</th><td>${exp.details}</td></tr>
                <tr><th>Amount</th><td>${exp.amount}</td></tr>
                <tr><th>Payment Mode</th><td>${exp.mode}</td></tr>
              </table>
            </div>
          `).join("")}
        </div>
        <div class="daily-footer">
          <h4 style="text-align:center;">Daily Calculations</h4>
          <table>
            <tr>
              <th>Total Expenses</th>
              <th>In Cash</th>
              <th>In Mpesa</th>
            </tr>
            <tr>
              <td>${total}</td>
              <td>${cashTotal}</td>
              <td>${mpesaTotal}</td>
            </tr>
          </table>
        </div>
      `;

      expensesContainer.appendChild(dayBox);
    });
}
async function downloadReport(dateKey) {
  showLoader();

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Get expenses for that date
    const dailyExpenses = allExpenses
      .filter(exp => exp.date === dateKey)
      .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

    const dayName = new Date(dateKey.split("/").reverse().join("-"))
      .toLocaleDateString("en-GB", { weekday: "long" });

    // HEADER BACKGROUND
    doc.setFillColor(230, 240, 255); // light background
    doc.roundedRect(10, 10, 190, 20, 5, 5, 'F');

    // HEADER TEXT
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text("Expenses Report", 14, 22); // left
    doc.text(`${dayName} ${dateKey}`, 200 - doc.getTextWidth(`${dayName} ${dateKey}`) - 14, 22); // right

    // TABLE DATA
    const tableData = dailyExpenses.map((exp, idx) => [
      idx + 1,
      exp.details,
      exp.amount,
      exp.mode
    ]);

    doc.autoTable({
      startY: 35,
      head: [["S/No.", "Description", "Amount", "Payment Mode"]],
      body: tableData,
      styles: { fontSize: 12, cellPadding: 4 },
      headStyles: { fillColor: [200, 200, 200] },
      columnStyles: {
        0: { halign: 'center', cellWidth: 20 },
        2: { halign: 'center', cellWidth: 30 },
        3: { halign: 'center', cellWidth: 40 }
      }
    });

    // FOOTER - Daily Calculations
    let total = 0, cashTotal = 0, mpesaTotal = 0;
    dailyExpenses.forEach(exp => {
      total += exp.amount;
      if (exp.mode === "Cash") cashTotal += exp.amount;
      if (exp.mode === "Mpesa") mpesaTotal += exp.amount;
    });

    let finalY = doc.lastAutoTable.finalY + 10;
    doc.setFillColor(241, 244, 248); // same background as UI
    doc.rect(10, finalY, 190, 20, 'F');

    // Draw separators
    doc.setDrawColor(200, 200, 200);
    doc.line(10 + 190/3, finalY, 10 + 190/3, finalY + 20);
    doc.line(10 + 2*(190/3), finalY, 10 + 2*(190/3), finalY + 20);

    // Footer text
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text("Total Expenses", 14, finalY + 7);
    doc.text(String(total), 14, finalY + 15);

    doc.text("In Cash", 10 + 190/3 + 4, finalY + 7);
    doc.text(String(cashTotal), 10 + 190/3 + 4, finalY + 15);

    doc.text("In Mpesa", 10 + 2*(190/3) + 4, finalY + 7);
    doc.text(String(mpesaTotal), 10 + 2*(190/3) + 4, finalY + 15);

    // SAVE FILE
    doc.save(`expense report ${dateKey}.pdf`);
  } catch (err) {
    console.error("Error generating report:", err);
  } finally {
    hideLoader();
  }
}

document.getElementById("salesSearch").addEventListener("input", function () {
  const query = this.value.toLowerCase();
  const dayBoxes = document.querySelectorAll(".day-box");
  let found = false;

  dayBoxes.forEach(box => {
    const dayText = box.dataset.day;
    const dateText = box.dataset.date;

    if (dayText.includes(query) || dateText.includes(query)) {
      box.style.display = "";
      found = true;
    } else { 
      box.style.display = "none";
    }
  });

  document.getElementById("noResults").classList.toggle("hidden", found);
});
  </script>
</body>
</html>