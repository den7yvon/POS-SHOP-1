<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POS | Orders</title>
  <link rel="shortcut icon" type="image/x-icon" href="Favicon.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {display: flex; font-family: 'Times New Roman', Times, serif; line-height: 1.4; min-height: 100vh;
      flex-direction: column; margin: 0; background-color: #f1f4f8;}

    .title {color: #003366; font-size: 24px; margin-bottom: 20px;}

    .main {background-color: white; border-radius: 15px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      padding: 25px; width: 90%; max-width: 400px; text-align: center;}

    .top-nav {width: 100%; height: 40px; background-color: #003366; color: white; display: flex;
      justify-content: space-between; align-items: center; padding: 0 15px; position: fixed;
      top: 0; z-index: 100;}
  
    .nav-left, .nav-center, .nav-right {display: flex; align-items: center; position: relative;}
  
    .menu-icon {font-size: 24px; cursor: pointer; margin-right: 10px;}
  
    .active-page {font-size: 16px; font-weight: 600;}
  
    .menu-dropdown {position: absolute; top: 40px; left: 0; background: white; color: #003366;
      border: 1px solid #ccc; border-radius: 6px; display: flex; flex-direction: column; width: 220px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);  overflow: hidden; z-index: 1000;  transform: scale(0);
      opacity: 0; transform-origin: top left; transition: transform 0.25s ease-out, opacity 0.2s ease-out;}
    
    .menu-dropdown a {padding: 10px; text-decoration: none; color: #003366; 
      border-bottom: 1px solid #eee; font-weight: 500;}
    
    .menu-dropdown a:hover {background-color: #f0f0f0;}
    
    .menu-dropdown.show { transform: scale(1); opacity: 1;}

    .nav-logo {font-size: 22px; font-weight: bold; margin-right: 70px;}

    .user-icon {cursor: pointer; margin-right: 30px;}
    
    .circle {width: 36px; height: 36px; background-color: white; border-radius: 50%; position: relative;
      display: flex; align-items: center; justify-content: center;}
    
    .head {width: 10px; height: 10px; background-color: #003366; border-radius: 50%;
      position: absolute; top: 8px;}
    
    .shoulders {width: 20px; height: 8px; background-color: #003366; border-radius: 50%; position: absolute;
      bottom: 8px;}

    .user-dropdown {position: absolute; top: 40px; right: 0; background: white;
      color: #003366; padding: 10px; border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1000; width: 160px; text-align: center; margin-right: 20px; transform-origin: top right;
      transform: scale(0); opacity: 0; transition: transform 0.25s ease-out, opacity 0.2s ease-out;
      display: block; pointer-events: none;}
    
    .user-dropdown.show {  transform: scale(1); opacity: 1; pointer-events: auto;}
    
    .user-dropdown p {margin: 0 0 10px;}
    
    .user-dropdown button {background-color: #003366; color: white; border: none; padding: 8px 12px;
      border-radius: 4px; cursor: pointer; width: 90%;}
    
    .user-dropdown button:hover {background-color: #0055aa;}

    .main-content {margin-top: 20px; padding: 20px;}

    .foot {width: 100%; background-color: white; color: #003366; text-align: center; padding: 2px 1px;
      position: fixed; bottom: 0; left: 0; font-size: 15px;}
      
    #pageLoader {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9);
        z-index: 9999; display: flex; align-items: center; justify-content: center;}
  
    .spinner {border: 6px solid #ccc; border-top: 6px solid #2f0fe4; border-radius: 50%; width: 40px; height: 40px;
        animation: spin 1s linear infinite;}
  
    @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}

    .orders-container {text-align: center; margin-top: 0px;}

    .welcome-message {font-size: 22px; color: #333; margin-bottom: 10px;}

    .button-group {display: flex; flex-direction: column; align-items: center; gap: 20px;}

    .order-btn {background: #003366; color: white; border: none; padding: 10px 15px; font-size: 16px;
      border-radius: 8px; cursor: pointer; width: 200px; font-weight: bold; opacity: 0;
      transform: translateY(50px); animation: slideUp 0.7s ease forwards;}

    .order-btn.add-order {animation-delay: 0.2s;}

    .order-btn.view-orders {animation-delay: 0.4s;}

    .order-btn:hover {background: #0055aa;}

    @keyframes slideUp {to {opacity: 1; transform: translateY(0);}}

    .popup-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); display: none; justify-content: center;
      align-items: center; z-index: 999;}

    .popup-content {background: #fff; width: 90%; max-width: 350px; border-radius: 12px 12px 12px 12px;
      padding: 0; transform: translateY(100%); transition: transform 0.4s ease; max-height: 75vh;
      display: flex; flex-direction: column;}

    .popup-header {display: flex; justify-content: space-between; align-items: center; background: #003366;
      color: white; padding: 12px 15px; border-radius: 12px 12px 0 0;}

    .popup-header h2 {margin: 0; font-size: 18px;}

    .close-popup {background: none; border: none; color: white; font-size: 22px; cursor: pointer;}

    .popup-body {padding: 15px; overflow-y: auto;}

    .popup-body label {display: block; margin-top: 5px; font-weight: bold; font-size: 14px;}

    .popup-body input,.popup-body textarea {width: 95%; padding: 10px; margin-top: 5px; border-radius: 6px;
      border: 1px solid #ccc; font-size: 14px;}

    textarea {resize: vertical; min-height: 30px;}

    .complete-btn {background: #003366; color: white; border: none; padding: 10px; border-radius: 8px;
      font-size: 16px; margin-top: 10px; font-weight: bold; cursor: pointer; width: 100%;}

    .complete-btn:hover {background: #0055aa;}

    .popup-overlay.show .popup-content {transform: translateY(0);}

    .checkmark {width: 80px; height: 80px; stroke: #003366; stroke-width: 4; stroke-linecap: round;
      stroke-linejoin: round; stroke-miterlimit: 10; animation: drawCircle 0.6s ease-in-out forwards;
      display: block; overflow: visible; box-sizing: content-box;}

    .checkmark-circle {stroke-dasharray: 166; stroke-dashoffset: 166;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;}

    .checkmark-check {stroke-dasharray: 48; stroke-dashoffset: 48;
      animation: stroke 0.3s 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;}

    @keyframes stroke {to {stroke-dashoffset: 0;}}

    @keyframes drawCircle {0% {transform: scale(0); opacity: 0;} 100% {transform: scale(1); opacity: 1;}}

    .tick-animation {display: flex; justify-content: center; align-items: center; margin: 20px 0;}

    .overlay {position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 9990;}

    .hidden {display: none;}

    .popup-conten.small {width: 300px; background-color: white; padding: 5px 5px; text-align: center; 
      align-items: center; border-radius: 10px;}

    .popup-buttons button.edit-back{background-color: #003366; color: white; cursor: pointer; width: 50%;
      font-weight: bold; margin-bottom: 10px;}

    .popup-buttons button.edit-back:hover{background-color: #0055aa;}

    .popup-buttons button {margin: 10px 5px 0; padding: 10px 15px; border: none; border-radius: 6px;
      font-weight: bold; cursor: pointer;}

    .search-bar-container {position: fixed; top: 45px; right: 20px; z-index: 50;}

    .search-bar-container input {padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px;}

    .orders-box {margin: 5px auto 10px; width: 100%; background: #fff; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column;}

    .orders-header {display: flex; justify-content: space-between; align-items: center; background: #003366;
      color: white; padding: 12px 20px; border-radius: 12px 12px 0 0;}

    .orders-header h4 {margin: 0;}

    .orders-header button {background: white; color: #003366; border: none; padding: 6px 12px;
      border-radius: 6px; font-size: 14px; cursor: pointer;}

    .orders-header button:hover {background: #02e6f7;}

    .orders-body {padding: 20px;}

    .order-card {position: relative; border: 1px solid #ccc; border-radius: 10px; padding: 15px;
      margin-bottom: 20px; border-left: 6px solid #003366; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}

    .order-card h4 {margin: 0; font-size: 13px;}

    .order-card-header {display: flex; justify-content: space-between; align-items: center;}

    .order-table-wrapper {margin-top: 12px; overflow-x: auto;}

    .order-table {border-collapse: collapse; width: 100%; min-width: 600px;}

    .order-table th, .order-table td {border: 1px solid #ddd; padding: 8px; font-size: 13px; text-align: center;}

    .order-table th {background: #ccc; color: Black;}

    .order-card::after {content: ""; position: absolute; right: 10px; bottom: 0px; width: 100px; height: 120px;
      background: url('CardB.jpg') no-repeat center/contain; opacity: 0.1; pointer-events: none;}

    .orders-footer {text-align: center; padding: 15px; border-top: 6px solid #003366; background: #f5f5f5;
      border-radius: 0 0 12px 12px; border-bottom: 6px solid #003366;}

    .orders-footer h3 {margin: 0;}

    .order-analysis {display: flex; justify-content: center; align-items: center; margin-top: 10px;}

    .analysis-col {flex: 1; text-align: center;}

    .analysis-col h4 {margin-bottom: 5px;}

    .divider {width: 2px; background: #ccc; align-self: stretch; margin: 0 20px; border-radius: 2px;}

    .status-pending {color: red; font-weight: bold;}

    .status-delivered {color: green; font-weight: bold;}

    .back-btn-edit {background-color: #003366 ; color: white; padding: 4px 4px; margin-top: 5px; 
      margin-bottom: 5px; font-size: 1rem; font-weight: 500; border: none; border-radius: 8px; 
      cursor: pointer; margin-bottom: 7px;}

    .back-btn-edit:hover {background-color: #0055aa;}

    .dots-wrapper {position: relative; display: inline-block;}

    .dots-btn {background: none; border: none; font-size: 18px; cursor: pointer;}

    .dropdown-menu {position: absolute; right: 0; top: 100%; background: #fff; border: 1px solid #ddd;
      border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 180px; padding: 5px 0;
      z-index: 100; opacity: 0; transform: translateY(-10px); pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;}

    .dropdown-menu:not(.hidden) {opacity: 1; transform: translateY(0); pointer-events: auto;}

    .dropdown-item {display: block; width: 100%; padding: 10px 15px; text-align: left; background: none;
      border: none; font-size: 14px; cursor: pointer; transition: background 0.2s;}

    .dropdown-item:hover {background: #f0f4ff;}

    .dropdown-item + .dropdown-item {border-top: 1px solid #eee;}

    .hidden {display: none;}

    .deliver-popup-overlay {position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);
      display: flex; align-items: center; justify-content: center; z-index: 9999;}

    .deliver-popup-content {background: #fff; border-radius: 10px; padding: 10px; width: 300px; max-width: 90%;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25); text-align: center;}

    .deliver-popup-content h2 {font-size: 20px; font-weight: bold; margin-bottom: 15px;}

    .deliver-popup-content p {margin-bottom: 20px; font-size: 16px;}

    .deliver-popup-actions {display: flex; justify-content: center; gap: 20px;}

    .btn-cancel {padding: 8px 16px; border: 1px solid #aaa; border-radius: 6px; background: #f9f9f9;
      cursor: pointer; font-weight: bold;}

    .btn-cancel:hover {background: #eee;}

    .btn-confirm {padding: 8px 16px; border: none; border-radius: 6px; background: #003366;
      color: #fff; font-weight: bold; cursor: pointer;}

    .btn-confirm:hover {background: #0055aa;}

    .hidden {display: none;}

    .edit-popup-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
      display: flex; align-items: center; justify-content: center; z-index: 1000;}

    .edit-popup-content {background: #fff; border-radius: 12px; padding: 0px; width: 300px; max-width: 100%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); transform: translateY(100px); opacity: 0; transition: all 0.3s ease;}

    .edit-popup-overlay:not(.hidden) .edit-popup-content {transform: translateY(0); opacity: 1;}

    .edit-popup-header {display: flex; justify-content: space-between; align-items: center; background: #003366;
      color: white; padding: 10px 15px; border-radius: 12px 12px 0 0;}

    .edit-popup-header h2 {margin: 0;}

    .edit-popup-close {background: none; border: none; font-size: 22px; cursor: pointer; color: white;}

    .form-group {margin-bottom: 12px;}

    .form-group label {display: block; font-weight: bold; margin-bottom: 5px; margin-left: 10px;}

    .form-group input,.form-group textarea {width: 85%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px;
      margin-left: 10px;}

    .btn-primary {background: #003366; color: #fff; border: none; width: 93%; margin-left: 10px;
      margin-bottom: 5px; padding: 10px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;}

    .btn-primary:hover {background: #0055aa;}

    .hidden {display: none;}

    .delete-popup-overlay {position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);
      display: flex; align-items: center; justify-content: center; z-index: 9999;}

    .delete-popup-content {background: #fff; border-radius: 10px; padding: 10px; width: 300px; max-width: 90%;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25); text-align: center;}

    .delete-popup-content h2 {font-size: 20px; font-weight: bold; margin-bottom: 15px;}

    .delete-popup-content p {margin-bottom: 20px; font-size: 16px;}

    .delete-popup-actions {display: flex; justify-content: center; gap: 20px;}

    .btn-cancel-delete {padding: 8px 16px; border: 1px solid #aaa; border-radius: 6px; background: #f9f9f9;
      cursor: pointer; font-weight: bold;}

    .btn-cancel-delete:hover {background: #eee;}

    .btn-confirm-delete {padding: 8px 16px; border: none; border-radius: 6px; background: #003366;
      color: #fff; font-weight: bold; cursor: pointer;}

    .btn-confirm-delete:hover {background: #0055aa;}

    .hidden {display: none;}
  </style>
</head>
<body class="dashboard-page">
    <!-- Loader Spinner -->
    <div id="pageLoader">
      <div class="spinner"></div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
      <div class="nav-left">
        <div class="menu-icon" onclick="toggleMenuDropdown()">‚ò∞</div>
        <span class="active-page" id="activePageName">Orders</span>
        <div class="menu-dropdown" id="menuDropdown">
          <a href="dashboard.html">‚û§ Dashboard</a>
          <a href="stock.html">‚û§ Stock</a>       
          <a href="expenses.html">‚û§ Expenses</a> 
          <a href="sales.html">‚û§ Sales Records</a>
          <a href="orders.html">‚û§ Orders Management</a>
          <a href="analysis.html">‚û§Analysis</a>
        </div>
      </div>

      <div class="nav-center">
        <span class="nav-logo">POS</span>
      </div>

      <div class="nav-right">
        <div class="user-icon" onclick="toggleUserDropdown()">
          <div class="circle">
            <div class="head"></div>
            <div class="shoulders"></div>
          </div>
        </div>
        <div class="user-dropdown" id="userDropdown">
          <p><strong>Piden Cyber, Electronics, Phones & Accessories</strong></p>
          <button onclick="logout()">Logout</button>
        </div>
      </div>
    </nav>

    <!-- Content Area Placeholder -->
    <main class="main-content">
      <div class="orders-container">
        <div id="addOrdersSection">
        <h1 class="welcome-message">Welcome to Orders Management</h1>
    
        <div class="button-group">
          <button class="order-btn add-order">‚ûï Add Order</button>
          <button class="order-btn view-orders">üìã View Orders</button>
        </div>
        </div>
      </div>

      <!-- Add Order Popup -->
      <div class="popup-overlay hidden" id="addOrderPopup">
        <div class="popup-content">
          <div class="popup-header">
            <h2>Add Order</h2>
            <button class="close-popup" id="closeAddOrder">&times;</button>
          </div>

          <div class="popup-body">
            <label>Client's Name</label>
            <input type="text" id="clientName" placeholder="Enter client's name">

            <label>Client's Contact</label>
            <input type="text" id="clientContact" placeholder="Enter contact">

            <label>Order Details</label>
            <textarea id="orderDetails" placeholder="Enter order details"></textarea>

            <label>Order Price</label>
            <input type="number" id="orderPrice" placeholder="Enter price">

            <button id="completeOrder" class="complete-btn">Complete</button>
          </div>
        </div>
      </div>

      <div id="successEditPopup" class="overlay hidden">
        <div class="popup-conten small">
          <h2>Order Added Successfully!</h2>
          <div class="tick-animation">
            <svg class="checkmark" viewBox="0 0 52 52">
              <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
              <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17"/>
            </svg>
          </div>
          <div class="popup-buttons">
            <button class="edit-back" onclick="returnToEditOptions()">Done</button>
          </div>
        </div>
      </div>

      <div id="viewOrdersSection" class="hidden">
        <!-- Floating Search Bar -->
        <div class="search-bar-container">
          <input type="text" id="orderSearch" placeholder="üîçe.g. Day/Date" />
        </div>
        <div>  
          <button class="back-btn-edit" onclick="goBackToStockMain()"><span class="white-arrow">‚Æú</span> Back</button>
        </div>
        <!-- Orders Main Box -->
        <div class="orders-box">
          <!-- Header -->
          <div class="orders-header">
            <h4>ORDER RECORDS</h4>
            <button id="downloadOrdersBtn">Download Report</button>
          </div>

          <!-- Body -->
          <div id="ordersContainer" class="orders-body">
            <!-- Orders will be injected here dynamically with JS -->
          </div>

          <!-- Footer -->
          <div class="orders-footer">
            <h3>Order Analysis</h3>
            <hr />
            <div class="order-analysis">
              <div class="analysis-col">
                <h4>Pending Orders</h4>
                <p id="pendingCount">0</p>
              </div>
              <div class="divider"></div>
              <div class="analysis-col">
                <h4>Delivered Orders</h4>
                <p id="deliveredCount">0</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Deliver Confirmation Popup -->
      <div id="deliverPopup" class="deliver-popup-overlay hidden">
        <div class="deliver-popup-content">
          <h2>Confirm Delivery</h2>
          <p>Are you sure you want to deliver this order?</p>
          <div class="deliver-popup-actions">
            <button id="cancelDeliverBtn" class="btn-cancel">‚ùåCancel</button>
            <button id="confirmDeliverBtn" class="btn-confirm">‚úÖConfirm</button>
          </div>
        </div>
      </div>

      <div id="successDeliveryPopup" class="overlay hidden">
        <div class="popup-conten small">
          <h2>Order Delivered Successfully!</h2>
          <div class="tick-animation">
            <svg class="checkmark" viewBox="0 0 52 52">
              <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
              <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17"/>
            </svg>
          </div>
          <div class="popup-buttons">
            <button class="edit-back" onclick="returnToOrders()">Done</button>
          </div>
        </div>
      </div>

      <!-- Edit Order Popup -->
      <div id="editOrderPopup" class="edit-popup-overlay hidden">
        <div class="edit-popup-content slide-up">
          <div class="edit-popup-header">
            <h2>Edit Order</h2>
            <button id="closeEditOrderBtn" class="edit-popup-close">&times;</button>
          </div>
          <form id="editOrderForm">
            <div class="form-group">
              <label for="editClientName">Client's Name</label>
              <input type="text" id="editClientName" name="client_name" required />
            </div>
            <div class="form-group">
              <label for="editContact">Client's Contact</label>
              <input type="text" id="editContact" name="contact" required />
            </div>
            <div class="form-group">
              <label for="editOrderDetails">Order Details</label>
              <textarea id="editOrderDetails" name="order_details" required></textarea>
            </div>
            <div class="form-group">
              <label for="editPrice">Order Price</label>
              <input type="number" id="editPrice" name="price" required />
            </div>
            <div class="popup-footer">
              <button type="submit" class="btn btn-primary">Complete</button>
            </div>
          </form>
        </div>
      </div>

      <div id="successOrderEditPopup" class="overlay hidden">
        <div class="popup-conten small">
          <h2>Order Edited Successfully!</h2>
          <div class="tick-animation">
            <svg class="checkmark" viewBox="0 0 52 52">
              <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
              <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17"/>
            </svg>
          </div>
          <div class="popup-buttons">
            <button class="edit-back" onclick="returnToOrderList()">Done</button>
          </div>
        </div>
      </div>

      <div id="deleteOrderPopup" class="delete-popup-overlay hidden">
        <div class="delete-popup-content">
          <h2>Confirm Delete</h2>
          <p>Are you sure you want to delete this order?</p>
          <div class="delete-popup-actions">
            <button id="cancelDeleteBtn" class="btn-cancel-delete">‚ùåCancel</button>
            <button id="confirmDeleteBtn" class="btn-confirm-delete">‚úÖConfirm</button>
          </div>
        </div>
      </div>

      <div id="successOrderDeletePopup" class="overlay hidden">
        <div class="popup-conten small">
          <h2>Order Deleted Successfully!</h2>
          <div class="tick-animation">
            <svg class="checkmark" viewBox="0 0 52 52">
              <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
              <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17"/>
            </svg>
          </div>
          <div class="popup-buttons">
            <button class="edit-back" onclick="returnToOrdersList()">Done</button>
          </div>
        </div>
      </div>
    </main>

  <!-- Footer -->
  <footer class="foot">
    &copy; 2025 Piden Company Limited.
  </footer>

  <!-- Supabase JS Library (must come FIRST before you use supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Supabase Initialization -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const supabaseUrl = "https://mzvlybnvgpemdayoylfk.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16dmx5Ym52Z3BlbWRheW95bGZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MjkyODMsImV4cCI6MjA2MTAwNTI4M30.bRg54tsPook5UrfUM1p3y2WWkZqv_u7vbHpBGBKrQ4E";
    window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
    });
  </script>
  
  <!-- Inline JS for dropdowns & logout -->
  <script>
    function toggleMenuDropdown() {
      document.getElementById("menuDropdown").classList.toggle("show");
      document.getElementById("userDropdown").classList.remove("show");
    }

    function toggleUserDropdown() {
      document.getElementById("userDropdown").classList.toggle("show");
      document.getElementById("menuDropdown").classList.remove("show");
    }

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    window.onload = () => {
      // Disable back button after logout
      if (!sessionStorage.getItem("loggedIn")) {
        window.location.replace("index.html");
      }
    }

    window.onclick = function(event) {
      if (!event.target.matches('.menu-icon') && !event.target.closest('.menu-dropdown')) {
        document.getElementById("menuDropdown").classList.remove("show");
      }
      if (!event.target.closest('.user-icon') && !event.target.closest('.user-dropdown')) {
        document.getElementById("userDropdown").classList.remove("show");
      }
    }

    window.addEventListener("load", () => {
        document.getElementById("pageLoader").style.display = "none";
      });

      // Optional global control for Supabase calls
      function showLoader() {
        document.getElementById("pageLoader").style.display = "flex";
      }

      function hideLoader() {
        document.getElementById("pageLoader").style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", () => {
      const addOrderBtn = document.querySelector(".add-order");
      const viewOrdersBtn = document.querySelector(".view-orders");
      const addOrderSection = document.getElementById("addOrdersSection");
      const viewOrdersSection = document.getElementById("viewOrdersSection");
      const ordersContainer = document.getElementById("ordersContainer");
      const orderSearch = document.getElementById("orderSearch");

      // Open popup
      addOrderBtn.addEventListener("click", () => {
        addOrderPopup.style.display = "flex";
        setTimeout(() => addOrderPopup.classList.add("show"), 10);
      });

      // Show View Orders section
      viewOrdersBtn.addEventListener("click", async () => {
        document.getElementById("addOrdersSection").classList.add("hidden");
        viewOrdersSection.classList.remove("hidden");
        await fetchOrders();
      }); 
      });

      const addOrderPopup = document.getElementById("addOrderPopup");
      const closeAddOrder = document.getElementById("closeAddOrder");
      const addOrderBtn = document.querySelector(".add-order");
      const completeOrderBtn = document.getElementById("completeOrder");
      const loader = document.getElementById("orderLoader");

      // Close popup
      function closeAddOrderPopup() {
        addOrderPopup.classList.remove("show");
        document.getElementById("clientName").value = "";
        document.getElementById("clientContact").value = "";
        document.getElementById("orderDetails").value = "";
        document.getElementById("orderPrice").value = "";
        setTimeout(() => addOrderPopup.style.display = "none", 400);
      }

      closeAddOrder.addEventListener("click", closeAddOrderPopup);

      // Insert into Supabase
      completeOrderBtn.addEventListener("click", async () => {
        const clientName = document.getElementById("clientName").value.trim();
        const clientContact = document.getElementById("clientContact").value.trim();
        const orderDetails = document.getElementById("orderDetails").value.trim();
        const orderPrice = document.getElementById("orderPrice").value.trim();

        if (!clientName || !clientContact || !orderDetails || !orderPrice) {
          alert("Please fill in all fields.");
          return;
        }

        showLoader();
        const today = new Date();
        const dateOfOrder = today.toLocaleDateString("en-GB"); // dd/mm/yyyy

        const { error } = await supabase
          .from("orders")
          .insert([{
            client_name: clientName,
            contact: clientContact,
            order_details: orderDetails,
            price: parseFloat(orderPrice),
            date_of_order: dateOfOrder,
            date_of_delivery: null,
            order_status: "Pending"
          }]);

        hideLoader();

        if (error) {
          alert("Error adding order: " + error.message);
        } else {
          showSuccessEditPopup(); 
          // Reset fields
          document.getElementById("clientName").value = "";
          document.getElementById("clientContact").value = "";
          document.getElementById("orderDetails").value = "";
          document.getElementById("orderPrice").value = "";
          }
      });

      function showSuccessEditPopup() {
              document.getElementById("successEditPopup").classList.remove("hidden");
            }

      function returnToEditOptions() {
        document.getElementById("successEditPopup").classList.add("hidden");
        closeAddOrderPopup(); 
      }

      let ordersData = [];

      // Fetch Orders from Supabase
      async function fetchOrders() {
        showLoader();
        const { data, error } = await supabase
          .from("orders")
          .select("*");

        if (error) {
          console.error("Error fetching orders:", error);
          return;
        }

        // Sort orders by parsed date (oldest first) and then by ID to prevent shuffling
        const sortedData = data.sort((a, b) => {
        const [dayA, monthA, yearA] = a.date_of_order.split("/").map(Number);
        const [dayB, monthB, yearB] = b.date_of_order.split("/").map(Number);

        const dateA = new Date(yearA, monthA - 1, dayA);
        const dateB = new Date(yearB, monthB - 1, dayB);

        // First sort by date
        const dateCompare = dateA - dateB;
        if (dateCompare !== 0) return dateCompare;

        // If dates are equal, sort by ID (stable order)
        return a.id - b.id;
      });

        ordersData = sortedData;
        renderOrders(sortedData);
        updateAnalysis(sortedData);
        hideLoader();
      }


      function formatOrderDate(dateStr) {
        // dateStr = "22/08/2025"
        const [day, month, year] = dateStr.split("/").map(Number);
        const orderDate = new Date(year, month - 1, day); // JS months are 0-based

        return orderDate.toLocaleDateString("en-GB", {
          weekday: "long",
          day: "2-digit",
          month: "2-digit",
          year: "numeric"
        });
      }

      // Render Orders
      function renderOrders(data) {
        ordersContainer.innerHTML = "";
        data.forEach((order, index) => {
          const card = document.createElement("div");
          card.className = "order-card";

          // Date formatting
          const formattedDate = formatOrderDate(order.date_of_order);

      // Delivery Date
      let deliveryDate = "Not Delivered";

      if (order.order_status === "Delivered" && order.date_of_delivery) {
        // Parse dd/mm/yyyy format
        const [day, month, year] = order.date_of_delivery.split("/").map(Number);
        const d = new Date(year, month - 1, day); // months are 0-based
        deliveryDate = d.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric"
        });
      }
          card.innerHTML = `
            <div class="order-card-header">
              <h4>Order ${index + 1}</h4>
              <div class="dots-wrapper">
                <span style="font-size:13px;"><b>${formattedDate}</b></span>
                <button class="dots-btn">‚ãÆ</button>
                <div class="dropdown-menu hidden">
                  <button class="dropdown-item deliver-btn" data-order-id="${order.id}">üöö Deliver Order</button>
                  <button class="dropdown-item edit-btn" data-order-id="${order.id}">‚úèÔ∏è Edit Order</button>
                  <button class="dropdown-item delete-btn" data-order-id="${order.id}">üóëÔ∏è Delete Order</button>
                </div>
              </div>
            </div>
            <div class="order-table-wrapper">
              <table class="order-table">
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Contact</th>
                    <th>Details</th>
                    <th>Price</th>
                    <th>Date of Delivery</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${order.client_name}</td>
                    <td>${order.contact}</td>
                    <td>${order.order_details}</td>
                    <td>${order.price}</td>
                    <td>${deliveryDate}</td>
                    <td class="${order.order_status === 'Pending' ? 'status-pending' : 'status-delivered'}">
                      ${order.order_status}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          `;
          ordersContainer.appendChild(card);

      // üîë Attach dropdown logic inside the loop
      const dotsBtn = card.querySelector(".dots-btn");
      const dropdown = card.querySelector(".dropdown-menu");

      dotsBtn.addEventListener("click", (e) => {
        e.stopPropagation();

        // Close all other dropdowns first
        document.querySelectorAll(".dropdown-menu").forEach(menu => {
          if (menu !== dropdown) menu.classList.add("hidden");
        });

        // Toggle this one
        dropdown.classList.toggle("hidden");
      });
        });
      }

      // Real-time search filter
      orderSearch.addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();

        const filtered = ordersData.filter(order => {
          // Format the date into readable string
          const formattedDate = formatOrderDate(order.date_of_order).toLowerCase(); 
          const dayName = formattedDate.split(",")[0]; // "wednesday"
          const rawDate = order.date_of_order.toLowerCase(); // "22/08/2025"

          return (
            formattedDate.includes(searchTerm) ||
            dayName.includes(searchTerm) ||
            rawDate.includes(searchTerm)
          );
        });

        if (filtered.length > 0) {
          renderOrders(filtered);
          updateAnalysis(filtered);
        } else {
          ordersContainer.innerHTML = `
            <div style="text-align:center; margin-top:30px;">
              <text style="font-size:100px">üïµÔ∏è‚Äç‚ôÇÔ∏è</text>
              <p style="font-weight:bold; color:#555;">No orders found from your search</p>
            </div>
          `;
          updateAnalysis([]); // reset counts
        }
      });


      // Update footer analysis
      function updateAnalysis(data) {
        const pending = data.filter(o => o.order_status === "Pending").length;
        const delivered = data.filter(o => o.order_status === "Delivered").length;

        document.getElementById("pendingCount").innerText = pending;
        document.getElementById("deliveredCount").innerText = delivered;
      }

      function goBackToStockMain() {
              window.location.href = "orders.html";
            }

     // Close all dropdowns when clicking outside
    document.addEventListener("click", () => {
      document.querySelectorAll(".dropdown-menu").forEach(menu => {
        menu.classList.add("hidden");
      });
    });

    const deliverPopup = document.getElementById("deliverPopup");
    const cancelDeliverBtn = document.getElementById("cancelDeliverBtn");
    const confirmDeliverBtn = document.getElementById("confirmDeliverBtn");

    let currentOrderId = null; // store which order we‚Äôre delivering

    // Open popup when Deliver Order button is clicked
    document.addEventListener("click", (e) => {
      const deliverBtn = e.target.closest(".deliver-btn");
      if (deliverBtn) {
        currentOrderId = deliverBtn.dataset.orderId;
        deliverPopup.classList.remove("hidden");
      }
    });

    // Cancel button
    cancelDeliverBtn.addEventListener("click", () => {
      deliverPopup.classList.add("hidden");
      currentOrderId = null;
    });

    // Confirm button
    confirmDeliverBtn.addEventListener("click", async () => {
      if (!currentOrderId) return;

      try {
        // Get today's date in dd/mm/yyyy format
        const now = new Date();
        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = now.getFullYear();
        const formattedDate = `${day}/${month}/${year}`;

        // Update Supabase
        const { error } = await supabase
          .from("orders")
          .update({
            order_status: "Delivered",
            date_of_delivery: formattedDate,   // add this
          })
          .eq("id", currentOrderId);

        if (error) throw error;

        // Close popup
        deliverPopup.classList.add("hidden");
        currentOrderId = null;

        // Refresh the orders
        await fetchOrders();
        showSuccessDeliveryPopup(); 
      } catch (err) {
        console.error("Error delivering order:", err.message);
        alert("Failed to update order status. Please try again.");
      }
    });


    function showSuccessDeliveryPopup() {
            document.getElementById("successDeliveryPopup").classList.remove("hidden");
          }

    function returnToOrders() {
        document.getElementById("successDeliveryPopup").classList.add("hidden");
      }

    const editOrderPopup = document.getElementById("editOrderPopup");
    const closeEditOrderBtn = document.getElementById("closeEditOrderBtn");
    const editOrderForm = document.getElementById("editOrderForm");

    let editOrderId = null;

      // Open popup when Edit button clicked
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("edit-btn")) {
          const orderId = e.target.closest(".dropdown-item").dataset?.orderId || e.target.dataset.orderId;
          editOrderId = orderId;

          // Find the order from ordersData
          const order = ordersData.find(o => o.id == orderId);
          if (!order) return;

          // Pre-fill form
          document.getElementById("editClientName").value = order.client_name;
          document.getElementById("editContact").value = order.contact;
          document.getElementById("editOrderDetails").value = order.order_details;
          document.getElementById("editPrice").value = order.price;

          // Show popup
          editOrderPopup.classList.remove("hidden");
        }
      });

      // Close popup
      closeEditOrderBtn.addEventListener("click", () => {
        editOrderPopup.classList.add("hidden");
        editOrderId = null;
      });

      // Handle form submit
      editOrderForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!editOrderId) return;

        const updatedData = {
          client_name: document.getElementById("editClientName").value.trim(),
          contact: document.getElementById("editContact").value.trim(),
          order_details: document.getElementById("editOrderDetails").value.trim(),
          price: parseFloat(document.getElementById("editPrice").value)
        };

        try {
          const { error } = await supabase
            .from("orders")
            .update(updatedData)
            .eq("id", editOrderId);

          if (error) throw error;

          editOrderPopup.classList.add("hidden");
          editOrderId = null;

          // Refresh orders
          await fetchOrders();
          showSuccessOrderEditPopup(); 
        } catch (err) {
          console.error("Error updating order:", err.message);
          alert("Failed to update order. Please try again.");
        }
      });

      function showSuccessOrderEditPopup() {
              document.getElementById("successOrderEditPopup").classList.remove("hidden");
            }

      function returnToOrderList() {
        document.getElementById("successOrderEditPopup").classList.add("hidden");
      }


      const deleteOrderPopup = document.getElementById("deleteOrderPopup");
      const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
      const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

      let deleteOrderId = null;

      // Open Delete Popup
      document.addEventListener("click", (e) => {
        const deleteBtn = e.target.closest(".delete-btn");
        
        // Make sure it's the dropdown delete, not confirm delete button
        if (deleteBtn && deleteBtn.dataset.orderId) {
          deleteOrderId = deleteBtn.dataset.orderId;
          deleteOrderPopup.classList.remove("hidden");
        }
      });

      cancelDeleteBtn.addEventListener("click", () => {
        deleteOrderPopup.classList.add("hidden");
        deleteOrderId = null;
      });

      confirmDeleteBtn.addEventListener("click", async () => {
        if (!deleteOrderId) return;

        try {
          const { error } = await supabase
            .from("orders")
            .delete()
            .eq("id", deleteOrderId);

          if (error) throw error;

          // Close popup
          deleteOrderPopup.classList.add("hidden");
          deleteOrderId = null;

          // Refresh orders list
          await fetchOrders();
          showSuccessOrderDeletePopup(); 
        } catch (err) {
          console.error("Error deleting order:", err.message);
          alert("Failed to delete order. Please try again.");
        }
      });

      function showSuccessOrderDeletePopup() {
              document.getElementById("successOrderDeletePopup").classList.remove("hidden");
            }

      function returnToOrdersList() {
        document.getElementById("successOrderDeletePopup").classList.add("hidden");
      }
  </script>
</body>
</html>