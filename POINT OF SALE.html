<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIDEN | POINT OF SALE</title>
    <link rel="shortcut icon" type="image/x-icon" href="Favicon.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
    /* Sidebar styles */
      
       .sidebar {
            width: 250px;
            height: 100%;
            position: fixed;
            top: 0;
            left: -250px;
            background-color: blue;
            color: white;
            padding-top: 20px;
            transition: 0.3s;
        }
        .sidebar.active {
            left: 0;
        }
        .sidebar ul {
            list-style-type: circle;
            padding: 10;
        }
        .sidebar ul li {
            padding: 8px;
            text-align: justify;
        }
        .sidebar ul li a {
            color: white;
            text-decoration: none;
        }
        .open-btn {
            font-size: 30px;
            cursor: pointer;
        }
        /* Rest of the styles */
        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            padding: 0;
            background-color: white;
        }        
        header {
            background-color: blue;
            color: white;
            padding: 0.1px;
            text-align: center;
            border-bottom-left-radius: 30%;
        }        
        footer {
            text-align: center;
            padding: 10px;
            border-top-right-radius: 30%;
        }        
        button {
            background-color: white;
            color: blue;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }
        button:hover {
            background-color: lime;
        }   

        .items-table-container {
            width: 80%;  /* Adjust width as needed */
            margin: 20px auto;  /* Centers the table horizontally */
            padding: 2px;
            overflow-x: auto;
            text-align: center; /* Centers the text in the table cells */
        }

        .items-table-container table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            margin: 0 auto; /* Centers the table within the container */
        }

        .items-table-container th, 
        .items-table-container td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ccc;
        }

        .items-table-container th {
            background-color: blue;
            color: white;
        }

        .items-table-container td {
            background-color: #f9f9f9;
        }

        .items-table-container button {
            padding: 5px 10px;
            background-color: blue;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        .items-table-container button:hover {
            background-color: lime;
            color: blue;
        }

        h1{
          text-align: center;
          background-color: blue;
          border-bottom-right-radius: 20%;
          border-bottom-left-radius: 20%;
          color: white;
          }
               
        /* Popup Styling */
        .popup {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); 
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            position: relative;
            text-align: center;
            color: blue;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .popup-header h2 {
            margin: 0;
        }

        .close-btn {
            background-color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color:blue ;
        }

        .close-btn:hover {
            background-color: lime;
            color: blue;
            
        }

        .popup-content input {
            width: 100%;
            padding: 8px;
            margin: 10px -10px;
            border: 5px solid blue;
            border-radius: 5px;  
        }

        .popup-content button {
            padding: 10px;
            background-color: blue;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }

        .popup-content button:hover {
            background-color: lime;
            color: blue;
        }

        /* Confirmation Popup Styling */
        .popup-content.confirm-popup {
            background-color: #f8d7da; /* Light red background */
            padding: 20px;
            border-radius: 8px;
            width: 250px;
            text-align: center;
            border: 1px solid blue; /* Slightly darker border */
            color: blue;
        }

        .popup-content.confirm-popup p {
            margin-bottom: 15px;
            color: blue; /* Dark red text */
            font-weight: bold;

        }

        .popup-content.confirm-popup .confirm-btn {
            padding: 8px 15px;
            background-color: #d9534f; /* Red background */
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }

        .popup-content.confirm-popup .confirm-btn:hover {
            background-color: #c9302c;
        }

        .popup-content.confirm-popup .cancel-btn {
            padding: 8px 15px;
            background-color: #6c757d; /* Grey background */
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }

        .popup-content.confirm-popup .cancel-btn:hover {
            background-color: #5a6268;
        }
        .make-sale-btn {
            padding: 10px 20px;
            background-color: blue;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .make-sale-btn:hover {
            background-color: lime;
            color: blue;
        }
        .make-sale-popup {
            max-width: 800px;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            overflow-y: auto; /* Enable vertical scrolling */
            overflow-x: auto; /* Enable vertical scrolling */
            z-index: 1000;
            max-height: 80vh;
        }

        .make-sale-popup .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .make-sale-popup .popup-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .make-sale-popup .close-btn {
            background-color: blue;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: white;
        }

        .make-sale-popup .close-btn:hover {
            color: red;
        }

        .sale-items-section {
            margin-bottom: 15px;
        }

        .sale-items-section table {
            width: 100%;
            border-collapse: collapse;
        }

        .sale-items-section th{
            background-color: blue;
            color: white;
        } 
        .sale-items-section td {
            padding: 8px;
            border: 1px solid #ddd;
        }

        .sale-items-section tbody tr:hover {
            background-color: #f1f1f1;
        }

        .proceed-btn {
            padding: 10px 20px;
            background-color: blue;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }

        .proceed-btn:hover {
            background-color: lime;
            color: blue;
        }

        .items-selection-section {
            padding-top: 10px;
            text-align: center;
        }

        .items-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .items-list .item {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 150px;
        }

        .items-list .item .add-btn {
            background-color: lime;
            color: blue;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .items-list .item .add-btn:hover {
            background-color: #28a745;
            color: white;
        }

        .search-container {
            margin-bottom: 15px;
            text-align: center;
        }

        .search-container input {
            width: 70%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .search-container input:focus {
            outline: none;
            border-color: blue;
        }

        .checkout-confirm-popup,
        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            background-color: #fff; /* White background for the content */
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            z-index: 2000; /* Ensure it is above the make-sale-popup */
            display: none;
        }

        .checkout-confirm-popup .popup-buttons,
        .success-popup .popup-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .checkout-confirm-popup .popup-buttons button,
        .success-popup .popup-buttons button {
            padding: 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }

        .checkout-confirm-popup .popup-buttons button:nth-child(1) {
            background-color: blue;
            color: white;
        }

        .checkout-confirm-popup .popup-buttons button:nth-child(1):hover {
            background-color: lime;
            color: blue;
        }

        .checkout-confirm-popup .popup-buttons button:nth-child(2) {
            background-color: red;
            color: white;
        }

        .checkout-confirm-popup .popup-buttons button:nth-child(2):hover {
            background-color: darkred;
        }

        .success-popup {
            background-color: #28a745;
            color: white;
            font-weight: bold;
            text-align: center;
            z-index: 2500;
        }

        /* Overlay for Make Sale Popup */
        #makeSaleOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent dark background */
            z-index: 998; /* Just below the Make Sale Popup */
            display: none;
        }

        /* Overlay for Confirm Checkout Popup */
        #confirmCheckoutOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent dark background */
            z-index: 1999; /* Just below the Confirm Checkout Popup */
            display: none;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <button class="close-btn" onclick="toggleSidebar()">×</button>
        <nav>
            <header style="background-color: white; color: blue; padding: 20px; font-size: 20px;"><b>NAVIGATION BAR</b></header>
            <ul>
                <b>
                <li><a href="homepage.html">HOMEPAGE</a></li>
                <li><a href="POINT OF SALE.html">POINT OF SALE</a></li>
                <li><a href="ADD STOCK.html">ADD STOCK</a></li>
                <li><a href="EXPENSES.html">EXPENSES</a></li>
                <li><a href="SALES RECORDS.html">SALES RECORDS</a></li>
                <li><a href="ORDERS MANAGEMENT.html">ORDERS MANAGEMENT</a></li>
                <li><a href="MY ACCOUNT.html">MY ACCOUNT</a></li>
                </b>
            </ul>
            <pre>




            </pre>
            <footer style="background-color: white; color: blue;"><b>We value your trust. Thank you for choosing PIDEN. </b></footer>
        </nav>
    </div>
    <div class="main-content">
        <header>
            <h1>
                <img src="Favicon.jpg" style="width: 50px; height: 50px; border-radius: 100%;">
                &nbsp&nbsp&nbsp&nbspPIDEN POINT OF SALE &nbsp&nbsp&nbsp&nbsp
                <button class="open-btn" style=" border-radius: 100%;" onclick="toggleSidebar()">☰</button>
            </h1>
        </header>
        <h1>POINT OF SALE</h1>

        <!-- MAKE SALE Button -->
        <div style="text-align: center; margin-bottom: 10px;">
            <button onclick="openSalePopup()" class="make-sale-btn">MAKE SALE</button>
        </div>

        <div class="items-table-container">
            <table id="itemsTable" border="10" cellspacing="0" cellpadding="10">
                <thead>
                    <tr>
                        <th>S/No</th>
                        <th>Item Name</th>
                        <th>Selling Price</th>
                        <th>Edit</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <!-- Items will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Edit Item Popup -->
        <div id="editPopup" class="popup">
            <div class="popup-content">
                <div class="popup-header">
                    <h2 id="editPopupTitle"></h2>
                    <button class="close-btn" onclick="closeEditPopup()">×</button>
                </div>
                
                <label for="buyingPrice">Enter new buying price:</label>
                <input type="number" id="buyingPrice" placeholder="Enter new buying price">

                <label for="sellingPrice">Enter new selling price:</label>
                <input type="number" id="sellingPrice" placeholder="Enter new selling price">

                <label for="additionalStock">Enter additional stock:</label>
                <input type="number" id="additionalStock" placeholder="Enter additional stock">

                <button onclick="updateItem()">Update</button>
                <button onclick="confirmDeleteItem()">Delete</button>
            </div>
        </div>

        <!-- Confirmation Popup -->
        <div id="confirmDeletePopup" class="popup">
            <div class="popup-content confirm-popup"> <!-- Added 'confirm-popup' class -->
                <p>Are you sure you want to delete this item?</p>
                <button class="confirm-btn" onclick="deleteItem()">Yes, Delete</button>
                <button class="cancel-btn" onclick="closeConfirmDeletePopup()">Cancel</button>
            </div>
        </div>

        <!-- Overlay for Make Sale Popup -->
        <div id="makeSaleOverlay" class="makeSaleOverlay">

            <!-- MAKE SALE Popup -->
        <div id="makeSalePopup" class="popup make-sale-popup">
            <div class="popup-header">
                <h2>MAKE SALE</h2>
                <button class="close-btn" onclick="closeMakeSalePopup()">×</button>
            </div>

            <!-- Items Selected for Sale Table -->
            <div class="sale-items-section">
                <table id="saleItemsTable" border="10" style="width: 100%; text-align: center; margin-bottom: 10px;">
                    <thead>
                        <tr>
                            <th>S/No</th>
                            <th>Item Name</th>
                            <th>Selling Price</th>
                            <th>Quantity</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody id="saleItemsBody">
                        <!-- Dynamically populated rows will appear here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: right;"><b>Total:</b></td>
                            <td colspan="2" id="totalSellingPrice">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Proceed to Checkout Button -->
            <div style="text-align: center; margin-bottom: 15px;">
                <button onclick="openCheckoutConfirmPopup()" class="proceed-btn">Proceed to Checkout</button>
            </div>

            <!-- Items Selection Section -->
            <div class="items-selection-section">
                <p>Select items for this sale:</p>
                <div class="search-container">
                    <input type="text" id="itemSearchInput" placeholder="Search for an item..." oninput="filterItems()">
                </div>
                <div id="itemsList" class="items-list">
                    <!-- Dynamically populated items will be listed here -->
                </div>
            </div>
        </div>
        </div>

        <!-- Overlay for Confirm Checkout Popup -->
        <div id="confirmCheckoutOverlay" class="confirmCheckoutOverlay">
        <!-- Checkout Confirmation Popup -->
        <div id="checkoutConfirmPopup" class="checkout-confirm-popup">
            <div class="popup-header">
                <p>Kindly Confirm Checkout</p>
                <button class="close-btn" onclick="closeCheckoutConfirmPopup()">×</button>
            </div>
            <div class="popup-buttons">
                <button onclick="confirmCheckout()">Checkout</button>
                <button onclick="closeCheckoutConfirmPopup()">Cancel</button>
            </div>
        </div>
        </div>

        <!-- Checkout Success Popup -->
        <div id="checkoutSuccessPopup" class="success-popup">
            <p>Checkout Successful</p>
        </div>

        <footer style="background-color: blue; color: white;">
            <p>&copy; 2025 PIDEN Point of Sale System</p>
        </footer>
    </div>

          <!-- Supabase JS Library (must come FIRST before you use supabase) -->
          <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

          <!-- Supabase Initialization -->
          <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const supabaseUrl = "https://drivactdliyzcshlousw.supabase.co";
            const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaXZhY3RkbGl5emNzaGxvdXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1NTY4ODUsImV4cCI6MjA2MjEzMjg4NX0.7NYTI6cZIjsQoxCwBjj4ELbSEvEQqrR66fNB3PNNVDo";
             window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
               });
          </script>

    <script>
      // Sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
              sidebar.classList.toggle("active");
            }
       
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'overlay-active';
        overlay.id = 'backgroundOverlay';
        document.body.appendChild(overlay);
        overlay.style.display = 'none'; // Initially hidden

        // Function to show the overlay
        function showOverlay() {
            overlay.style.display = 'block';
        }

        // Function to hide the overlay
        function hideOverlay() {
            overlay.style.display = 'none';
        }
       

       // Global variable to store the current item ID (set when editing)
        let currentItemId = null;
        let currentStock = null; // To store the current stock for adding additional stock

        // Fetch and display items from Supabase (including the 'data-item-id' for each row)
        async function fetchItems() {
            try {
                const { data, error } = await supabase
                    .from('items')
                    .select('id, name, stock, selling_price');

                if (error) {
                    console.log("Error fetching items:", error);
                    return;
                }

                const tableBody = document.getElementById("itemsTableBody");
                tableBody.innerHTML = "";

                data.forEach((item, index) => {
                    const row = `
                        <tr data-item-id="${item.id}">
                            <td>${index + 1}</td>
                            <td>${item.name}</td>                    
                            <td>${item.selling_price}</td>
                            <td><button onclick="editItem(${item.id})">Edit</button></td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (err) {
                console.log("Error:", err);
            }
        }

        // Function to open the Edit Popup
        async function editItem(itemId) {
            try {
                const { data, error } = await supabase
                    .from('items')
                    .select('name, buying_price, selling_price, stock')
                    .eq('id', itemId)
                    .single();

                if (error) {
                    console.log("Error fetching item:", error);
                    return;
                }

                currentStock = data.stock;
                document.getElementById("editPopupTitle").innerText = `Edit Item: ${data.name}`;
                document.getElementById("buyingPrice").value = data.buying_price;
                document.getElementById("sellingPrice").value = data.selling_price;
                document.getElementById("additionalStock").value = "";
                currentItemId = itemId;

                document.getElementById("editPopup").style.display = "flex";
            } catch (err) {
                console.log("Error:", err);
            }
        }

        // Close the edit popup
        function closeEditPopup() {
            document.getElementById("editPopup").style.display = "none";
        }

        // Update the item with new values
        async function updateItem() {
            const buyingPrice = document.getElementById("buyingPrice").value;
            const sellingPrice = document.getElementById("sellingPrice").value;
            const additionalStock = document.getElementById("additionalStock").value;

            // Calculate the new stock by adding the additional stock to the current stock
            const newStock = parseInt(currentStock) + (parseInt(additionalStock) || 0);

            try {
                const { error } = await supabase
                    .from('items')
                    .update({
                        buying_price: buyingPrice,
                        selling_price: sellingPrice,
                        stock: newStock
                    })
                    .eq('id', currentItemId);

                if (error) {
                    console.log("Error updating item:", error);
                } else {
                    alert("Item updated successfully!");
                    closeEditPopup();
                    fetchItems(); // Refresh the item list after update
                }
            } catch (err) {
                console.log("Error:", err);
            }
        }

        // Function to confirm item deletion
        function confirmDeleteItem() {
            document.getElementById("confirmDeletePopup").style.display = "flex";
        }

        // Function to close the confirmation popup
        function closeConfirmDeletePopup() {
            document.getElementById("confirmDeletePopup").style.display = "none";
        }

        // Delete the item
        async function deleteItem() {
            try {
                const { error } = await supabase
                    .from('items')
                    .delete()
                    .eq('id', currentItemId);

                if (error) {
                    console.log("Error deleting item:", error);
                } else {
                    alert("Item deleted successfully!");
                    closeConfirmDeletePopup();
                    closeEditPopup();
                    fetchItems(); // Refresh the item list
                }
            } catch (err) {
                console.log("Error:", err);
            }
        }

        // Fetch Items for Sale Popup and Populate Item Selection List
        async function fetchSaleItems() {
            const { data, error } = await supabase
                .from('items')
                .select('id, name, selling_price');

            if (error) {
                console.error("Error fetching items:", error.message);
                return;
            }

            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';

            data.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    ${item.name}
                    <button class="add-btn" onclick="addItemToSale(${item.id}, '${item.name}', ${item.selling_price})">Add</button>
                `;
                itemsList.appendChild(itemDiv);
            });
        }

        // Call fetchSaleItems when the popup opens
        function openSalePopup() {
            document.getElementById('makeSalePopup').style.display = 'block';
            fetchSaleItems();
            document.getElementById("makeSaleOverlay").style.display = "block"; // Show overlay
        }

        function closeMakeSalePopup() {
            document.getElementById('makeSalePopup').style.display = 'none';
            document.getElementById("makeSaleOverlay").style.display = "none"; // Hide overlay
        }
      // Array to store selected sale items
        let saleItems = [];

        // Add Item to Sale
        async function addItemToSale(id, name, sellingPrice) {
            try {
                // Fetch the buying price from Supabase
                const { data, error } = await supabase
                    .from('items')
                    .select('buying_price')
                    .eq('id', id)
                    .single();

                if (error) {
                    console.error('Error fetching buying price:', error);
                    return;
                }

                const buyingPrice = data.buying_price;

                // Check if the item already exists in the sale
                const existingItem = saleItems.find(item => item.id === id);

                if (existingItem) {
                    // Increase quantity if item already exists
                    existingItem.quantity += 1;
                } else {
                    // Add new item to the sale
                    saleItems.push({
                        id,
                        name,
                        buyingPrice,
                        sellingPrice,
                        quantity: 1,
                        profit: sellingPrice - buyingPrice
                    });
                }

                updateSaleTable();
                calculateTotal();
            } catch (err) {
                console.error('Error adding item to sale:', err);
            }
        }

        // Update Sale Table
        function updateSaleTable() {
            const saleItemsBody = document.getElementById('saleItemsBody');
            saleItemsBody.innerHTML = '';

            saleItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td><input type="number" value="${item.sellingPrice}" min="0" onchange="updateSellingPrice(${item.id}, this.value)" /></td>
                    <td><input type="number" value="${item.quantity}" min="1" onchange="updateQuantity(${item.id}, this.value)" /></td>
                    <td><button onclick="removeItem(${item.id})">Delete</button></td>
                `;
                saleItemsBody.appendChild(row);
            });
        }

        // Update Quantity
        function updateQuantity(id, newQuantity) {
            const item = saleItems.find(item => item.id === id);
            if (item) {
                item.quantity = parseInt(newQuantity);
                item.stockAmount = item.buyingPrice * item.quantity; // Recalculate stock amount
                item.profit = item.sellingPrice * item.quantity - item.stockAmount; // Recalculate profit
                calculateTotal();
            }
        }

        // Update Selling Price
        function updateSellingPrice(id, newPrice) {
            const item = saleItems.find(item => item.id === id);
            if (item) {
                item.sellingPrice = parseFloat(newPrice);
                item.profit = item.sellingPrice * item.quantity - item.stockAmount; // Recalculate profit
                calculateTotal();
            }
        }

        // Calculate Total Selling Price
        function calculateTotal() {
            let total = 0;

            saleItems.forEach(item => {
                total += item.sellingPrice * item.quantity;
            });

            document.getElementById('totalSellingPrice').textContent = total.toFixed(2);
        }

        // Remove Item from Sale
        function removeItem(id) {
            saleItems = saleItems.filter(item => item.id !== id);
            updateSaleTable();
            calculateTotal();
        }

        function filterItems() {
            const searchTerm = document.getElementById('itemSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('.items-list .item');

            items.forEach(item => {
                const itemName = item.textContent.toLowerCase();
                if (itemName.includes(searchTerm)) {
                    item.style.display = "flex"; // Show matching item
                } else {
                    item.style.display = "none"; // Hide non-matching item
                }
            });
        }

        // Open the Checkout Confirmation Popup
        async function openCheckoutConfirmPopup() {
            console.log("Attempting to open checkout confirmation popup...");

            const confirmPopup = document.getElementById('checkoutConfirmPopup');
            const overlay = document.getElementById('confirmCheckoutOverlay');

            // Ensure that saleItems is not empty before proceeding
            if (saleItems.length === 0) {
                alert("No items selected for sale.");
                console.warn("Checkout attempted with no sale items.");
                return;
            }

            try {
                saleItemsData = []; // Reset before repopulating

                for (const item of saleItems) {
                    console.log(`Processing item for checkout:`, item);

                    // Fetch the buying price from Supabase for each item
                    const { data, error } = await supabase
                        .from('items')
                        .select('buying_price')
                        .eq('name', item.name)
                        .single();

                    if (error) {
                        console.error(`Error fetching buying price for ${item.name}:`, error.message);
                        continue; // Skip this item in case of error
                    }

                    const buyingPrice = data ? data.buying_price : 0;
                    const stockAmount = buyingPrice * item.quantity;
                    const sellingPrice = item.sellingPrice * item.quantity;
                    const profit = sellingPrice - stockAmount;

                    // Push the processed item data into saleItemsData array
                    saleItemsData.push({
                        name: item.name,
                        quantity: item.quantity,
                        sellingPrice: item.sellingPrice, // Per item selling price
                        totalSellingPrice: sellingPrice, // Total selling price for quantity
                        stockAmount: stockAmount,
                        profit: profit,
                    });
                }

                // Debugging: To confirm the saleItemsData structure
                console.log("Sale Items Data prepared for checkout:", saleItemsData);

                // If saleItemsData is still empty after processing, notify the user
                if (saleItemsData.length === 0) {
                    alert("No valid items to process.");
                    console.warn("Checkout data preparation resulted in an empty array.");
                    return;
                }

                // Display the popup and overlay only after data processing is complete
                confirmPopup.style.display = 'block';
                confirmPopup.style.zIndex = 2500;
                overlay.style.display = 'block';
                overlay.style.zIndex = 2400;

                console.log("Confirm Checkout Popup and Overlay displayed successfully.");

            } catch (err) {
                console.error("Error processing sale items for checkout:", err);
                alert("Error processing sale items. Please try again.");
            }
        }


        // Close the Checkout Confirmation Popup
        function closeCheckoutConfirmPopup() {
            const confirmPopup = document.getElementById('checkoutConfirmPopup');
            confirmPopup.style.display = 'none';
            document.getElementById('confirmCheckoutOverlay').style.display = 'none';

            // Only clear saleItemsData if we are canceling the checkout, not confirming it
            if (!isCheckoutConfirmed) {
                console.log("Checkout canceled. Clearing saleItemsData.");
                saleItemsData = [];
            }
        }

        // Confirm Checkout
        async function confirmCheckout() {
            console.log("Attempting to confirm checkout...");
            console.log("Current saleItemsData:", saleItemsData);

            isCheckoutConfirmed = true;  // Set flag to prevent clearing data prematurely

            closeCheckoutConfirmPopup(); // This will not clear saleItemsData now

            // Show Success Popup
            const successPopup = document.getElementById('checkoutSuccessPopup');
            successPopup.style.display = 'block';
            successPopup.style.zIndex = 2500;

            if (!Array.isArray(saleItemsData) || saleItemsData.length === 0) {
                console.warn("No items to checkout. saleItemsData:", saleItemsData);
                alert("No items to checkout.");
                successPopup.style.display = 'none';
                return;
            }

            try {
                const formattedSalesData = saleItemsData.map(item => ({
                    item_name: item.name,
                    quantity: item.quantity,
                    stock_amount: item.stockAmount,
                    selling_amount: item.totalSellingPrice,
                    profit: item.profit,
                    time_sold: new Date().toLocaleTimeString(),
                    sale_date: new Date().toLocaleDateString(),
                    day_of_week: new Date().toLocaleString('en-US', { weekday: 'long' })
                }));

                console.log("Data to be inserted into sales table:", formattedSalesData);

                const { error } = await supabase.from('sales').insert(formattedSalesData);
                if (error) {
                    console.error("Error inserting sales data:", error.message);
                    alert("Error processing the sale. Please try again.");
                } else {
                    console.log("Sales data successfully inserted.");
                    saleItemsData = [];
                }
            } catch (err) {
                console.error("Error during checkout processing:", err);
                alert("Error processing the sale. Please try again.");
            }

            setTimeout(() => {
                successPopup.style.display = 'none';
                location.reload();
            }, 1000);

            isCheckoutConfirmed = false;  // Reset flag after processing
        }

        // Polling function to refresh items every 1 seconds
        setInterval(fetchItems, 1000);

        // Call the function to load items when the page loads
        document.addEventListener("DOMContentLoaded", function() {
            fetchItems();
        });
    </script>
</body>
</html>